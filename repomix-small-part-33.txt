s
__pycache__/
*.py[cod]
*$py.class

# C extensions
*.so

# Distribution / packaging
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
parts/
sdist/
var/
wheels/
pip-wheel-metadata/
share/python-wheels/
*.egg-info/
.installed.cfg
*.egg
MANIFEST

# PyInstaller
#  Usually these files are written by a python script from a template
#  before PyInstaller builds the exe, so as to inject date/other infos into it.
*.manifest
*.spec

# Installer logs
pip-log.txt
pip-delete-this-directory.txt

# Unit test / coverage reports
htmlcov/
.tox/
.nox/
.coverage
.coverage.*
.cache
nosetests.xml
coverage.xml
*.cover
*.py,cover
.hypothesis/
.pytest_cache/
pytestdebug.log

# Translations
*.mo
*.pot

# Django stuff:
*.log
local_settings.py
db.sqlite3
db.sqlite3-journal

# Flask stuff:
instance/
.webassets-cache

# Scrapy stuff:
.scrapy

# Sphinx documentation
docs/_build/
doc/_build/

# PyBuilder
target/

# Jupyter Notebook
.ipynb_checkpoints

# IPython
profile_default/
ipython_config.py

# pyenv
.python-version

# pipenv
#   According to pypa/pipenv#598, it is recommended to include Pipfile.lock in version control.
#   However, in case of collaboration, if having platform-specific dependencies or dependencies
#   having no cross-platform support, pipenv may install dependencies that don't work, or not
#   install all needed dependencies.
#Pipfile.lock

# poetry
#poetry.lock

# PEP 582; used by e.g. github.com/David-OConnor/pyflow
__pypackages__/

# Celery stuff
celerybeat-schedule
celerybeat.pid

# SageMath parsed files
*.sage.py

# Environments
# .env
.env/
.venv/
env/
venv/
ENV/
env.bak/
venv.bak/
pythonenv*

# Spyder project settings
.spyderproject
.spyproject

# Rope project settings
.ropeproject

# mkdocs documentation
/site

# mypy
.mypy_cache/
.dmypy.json
dmypy.json

# Pyre type checker
.pyre/

# pytype static type analyzer
.pytype/

# operating system-related files
*.DS_Store #file properties cache/storage on macOS
Thumbs.db #thumbnail cache on Windows

# profiling data
.prof


### Windows ###
# Windows thumbnail cache files
Thumbs.db
Thumbs.db:encryptable
ehthumbs.db
ehthumbs_vista.db

# Dump file
*.stackdump

# Folder config file
[Dd]esktop.ini

# Recycle Bin used on file shares
$RECYCLE.BIN/

# Windows Installer files
*.cab
*.msi
*.msix
*.msm
*.msp

# Windows shortcuts
*.lnk

# End of https://www.toptal.com/developers/gitignore/api/intellij+all,python,pycharm+all,macos,windows
/backend/models/V2/ch_rec/inference.pdiparams
/backend/models/V4/ch_det/inference.pdiparams
/backend/models/big-lama/models/best.ckpt
/backend/models/sam/sam.pth
/output/
/backend/test.py
/dylib/
/settings.ini
/test*.py
/subtitle.ini
*_no_sub.mp4
/backend/ffmpeg/win_x64/ffmpeg.exe
/test/pic_test/
demo*.mp4
out*.mp4
test*.py
test_*.mp4
test*_no_sub*.mp4
/test/coods/
/local_test/
/backend/models/video/ProPainter.pth
/backend/models/big-lama/big-lama.pt
/test/debug/
/backend/tools/train/release_model/
model.onnx
</file>

<file path="README_en.md">
[ç®€ä½“ä¸­æ–‡](README.md) | English

## Project Introduction

![License](https://img.shields.io/badge/License-Apache%202-red.svg)
![python version](https://img.shields.io/badge/Python-3.11+-blue.svg)
![support os](https://img.shields.io/badge/OS-Windows/macOS/Linux-green.svg)

Video-subtitle-remover (VSR) is an AI-based software that removes hardcoded subtitles from videos. It mainly implements the following functionalities:

- **Lossless resolution**: Removes hardcoded subtitles from videos and generates files without subtitles.
- Fills in the removed subtitle text area using a powerful AI algorithm model (non-adjacent pixel filling and mosaic removal).
- Supports custom subtitle positions by only removing subtitles in the defined location (input position).
- Supports automatic removal of all text throughout the entire video (without inputting a position).
- Supports multi-selection of images for batch removal of watermark text.

<p style="text-align:center;"><img src="https://github.com/YaoFANGUK/video-subtitle-remover/raw/main/design/demo.png" alt="demo.png"/></p>

> Download the .zip package directly, extract, and run it. If it cannot run, follow the tutorial below to try installing the conda environment and running the source code.

**Download Links:**

Windows GPU Version v1.1.0 (GPU):

- Baidu Cloud Disk: <a href="https://pan.baidu.com/s/1zR6CjRztmOGBbOkqK8R1Ng?pwd=vsr1">vsr_windows_gpu_v1.1.0.zip</a> Extraction Code: **vsr1**

- Google Drive: <a href="https://drive.google.com/drive/folders/1NRgLNoHHOmdO4GxLhkPbHsYfMOB_3Elr?usp=sharing">vsr_windows_gpu_v1.1.0.zip</a>


**Pre-built Package Comparison**:

| Pre-built Package Name          | Python | Paddle | Torch | Environment                       | Supported Compute Capability Range |
|----------------------------------|--------|--------|--------|-----------------------------------|------------------------------------|
| `vse-windows-directml.7z`        | 3.12   | 3.0.0 | 2.4.1 | Windows without Nvidia GPU         | Universal                         |
| `vse-windows-nvidia-cuda-11.8.7z`| 3.12   | 3.0.0 | 2.7.0 | CUDA 11.8                         | 3.5 â€“ 8.9                          |
| `vse-windows-nvidia-cuda-12.6.7z`| 3.12   | 3.0.0 | 2.7.0 | CUDA 12.6                         | 5.0 â€“ 8.9                          |
| `vse-windows-nvidia-cuda-12.8.7z`| 3.12   | 3.0.0 | 2.7.0 | CUDA 12.8                         | 5.0 â€“ 9.0+                          |

> NVIDIA provides a list of supported compute capabilities for each GPU model. You can refer to the following link: [CUDA GPUs](https://developer.nvidia.com/cuda-gpus) to check which CUDA version is compatible with your GPU.

**Docker Versions:**
```shell
  # Nvidia 10, 20, 30 Series Graphics Cards
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-cuda11.8 

  # Nvidia 40 Series Graphics Cards
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-cuda12.6 

  # Nvidia 50 Series Graphics Cards
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-cuda12.8 

  # AMD / Intel Dedicated or Integrated Graphics
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-directml 

  # Demo video, input
  /vsr/test/test.mp4
  docker cp vsr:/vsr/test/test_no_sub.mp4 ./
```

## Demonstration

- GUI:

<p style="text-align:center;"><img src="https://github.com/YaoFANGUK/video-subtitle-remover/raw/main/design/demo2.gif" alt="demo2.gif"/></p>

- <a href="https://b23.tv/guEbl9C">Click to view demo videoğŸ‘‡</a>

<p style="text-align:center;"><a href="https://b23.tv/guEbl9C"><img src="https://github.com/YaoFANGUK/video-subtitle-remover/raw/main/design/demo.gif" alt="demo.gif"/></a></p>

## Source Code Usage Instructions

#### 1. Install Python

Please ensure that you have installed Python 3.12+.

- Windows users can go to the [Python official website](https://www.python.org/downloads/windows/) to download and install Python.
- MacOS users can install using Homebrew:
  ```shell
  brew install python@3.12
  ```
- Linux users can install via the package manager, such as on Ubuntu/Debian:
  ```shell
  sudo apt update && sudo apt install python3.12 python3.12-venv python3.12-dev
  ```

#### 2. Install Dependencies

It is recommended to use a virtual environment to manage project dependencies to avoid conflicts with the system environment.

(1) Create and activate the virtual environment:
```shell
python -m venv videoEnv
```

- Windows:
```shell
videoEnv\\Scripts\\activate
```
- MacOS/Linux:
```shell
source videoEnv/bin/activate
```

#### 3. Create and Activate Project Directory

Change to the directory where your source code is located:
```shell
cd <source_code_directory>
```
> For example, if your source code is in the `tools` folder on the D drive and the folder name is `video-subtitle-remover`, use:
> ```shell
> cd D:/tools/video-subtitle-remover-main
> ```

#### 4. Install the Appropriate Runtime Environment

This project supports two runtime modes: CUDA (NVIDIA GPU acceleration) and DirectML (AMD, Intel, and other GPUs/APUs).

##### (1) CUDA (For NVIDIA GPU users)

> Make sure your NVIDIA GPU driver supports the selected CUDA version.

- Recommended CUDA 11.8, corresponding to cuDNN 8.6.0.

- Install CUDA:
  - Windows: [Download CUDA 11.8](https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_522.06_windows.exe)
  - Linux:
    ```shell
    wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run
    sudo sh cuda_11.8.0_520.61.05_linux.run
    ```
  - CUDA is not supported on MacOS.

- Install cuDNN (CUDA 11.8 corresponds to cuDNN 8.6.0):
  - [Windows cuDNN 8.6.0 Download](https://developer.download.nvidia.cn/compute/redist/cudnn/v8.6.0/local_installers/11.8/cudnn-windows-x86_64-8.6.0.163_cuda11-archive.zip)
  - [Linux cuDNN 8.6.0 Download](https://developer.download.nvidia.cn/compute/redist/cudnn/v8.6.0/local_installers/11.8/cudnn-linux-x86_64-8.6.0.163_cuda11-archive.tar.xz)
  - Follow the installation guide in the NVIDIA official documentation.

- Install PaddlePaddle GPU version (CUDA 11.8):
  ```shell
  pip install paddlepaddle-gpu==3.0.0 -i https://www.paddlepaddle.org.cn/packages/stable/cu118/
  ```

- Install Torch GPU version (CUDA 11.8):
  ```shell
  pip install torch==2.7.0 torchvision==0.22.0 --index-url https://download.pytorch.org/whl/cu118
  ```

- Install other dependencies:
  ```shell
  pip install -r requirements.txt
  ```

##### (2) DirectML (For AMD, Intel, and other GPU/APU users)

- Suitable for Windows devices with AMD/NVIDIA/Intel GPUs.
- Install ONNX Runtime DirectML version:
  ```shell
  pip install paddlepaddle==3.0.0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
  pip install -r requirements.txt
  pip install -r requirements_directml.txt
  ```


#### 4. Run the program

- Run the graphical interface

```shell
python gui.py
```

- Run the command line version (CLI)

```shell
python ./backend/main.py
```

## Common Issues

1. How to deal with slow removal speed

You can greatly increase the removal speed by modifying the parameters in backend/config.py:

```python
MODE = InpaintMode.STTN  # Set to STTN algorithm
STTN_SKIP_DETECTION = True # Skip subtitle detection
```

2. What to do if the video removal results are not satisfactory

Modify the values in backend/config.py and try different removal algorithms. Here is an introduction to the algorithms:

> - **InpaintMode.STTN** algorithm: Good for live-action videos and fast in speed, capable of skipping subtitle detection
> - **InpaintMode.LAMA** algorithm: Best for images and effective for animated videos, moderate speed, unable to skip subtitle detection
> - **InpaintMode.PROPAINTER** algorithm: Consumes a significant amount of VRAM, slower in speed, works better for videos with very intense movement

- Using the STTN algorithm

```python
MODE = InpaintMode.STTN  # Set to STTN algorithm
# Number of neighboring frames, increasing this will increase memory usage and improve the result
STTN_NEIGHBOR_STRIDE = 10
# Length of reference frames, increasing this will increase memory usage and improve the result
STTN_REFERENCE_LENGTH = 10
# Set the maximum number of frames processed simultaneously by the STTN algorithm, a larger value leads to slower processing but better results
# Ensure that STTN_MAX_LOAD_NUM is greater than STTN_NEIGHBOR_STRIDE and STTN_REFERENCE_LENGTH
STTN_MAX_LOAD_NUM = 30
```
- Using the LAMA algorithm

```python
MODE = InpaintMode.LAMA  # Set to LAMA algorithm
LAMA_SUPER_FAST = False  # Ensure quality
```


3. CondaHTTPError

Place the .condarc file from the project in the user directory (C:/Users/<your_username>). If the file already exists in the user directory, overwrite it.

Solution: https://zhuanlan.zhihu.com/p/260034241

4. 7z file extraction error

Solution: Upgrade the 7-zip extraction program to the latest version.
</file>

<file path="requirements.txt">
albumentations~=1.4.10
filesplit==3.0.2
opencv-python==4.11.0.86
scikit-image==0.25.2
imgaug==0.4.0
pyclipper==1.3.0.post6
lmdb==1.6.2
PyYAML==6.0.2
omegaconf==2.3.0
tqdm==4.67.1
PySimpleGUI-4-foss==4.60.4.1
easydict==1.13
scikit-learn==1.6.1
pandas==2.2.3
webdataset==0.2.111
numpy==2.2.5
protobuf==6.30.2
av==14.3.0
einops==0.8.1
paddleocr==2.10.0
paddle2onnx==1.3.1
onnxruntime==1.20.1
onnxruntime-directml==1.20.1;  sys_platform == 'win32'
</file>

<file path="gui.py">
# -*- coding: utf-8 -*-
"""
@Author  : Fang Yao
@Time    : 2023/4/1 6:07 ä¸‹åˆ
@FileName: gui.py
@desc: å­—å¹•å»é™¤å™¨å›¾å½¢åŒ–ç•Œé¢
"""
â‹®----
class SubtitleRemoverGUI
â‹®----
def __init__(self)
â‹®----
# è®¾ç½®è§†é¢‘é¢„è§ˆåŒºåŸŸå¤§å°
â‹®----
# é»˜è®¤ç»„ä»¶å¤§å°
â‹®----
# åˆ†è¾¨ç‡ä½äº1080
â‹®----
# å­—å¹•æå–å™¨å¸ƒå±€
â‹®----
# å­—å¹•æå–å…¶çª—å£
â‹®----
# è§†é¢‘è·¯å¾„
â‹®----
# è§†é¢‘cap
â‹®----
# è§†é¢‘çš„å¸§ç‡
â‹®----
# è§†é¢‘çš„å¸§æ•°
â‹®----
# è§†é¢‘çš„å®½
â‹®----
# è§†é¢‘çš„é«˜
â‹®----
# è®¾ç½®å­—å¹•åŒºåŸŸé«˜å®½
â‹®----
# å­—å¹•æå–å™¨
â‹®----
def run(self)
â‹®----
# åˆ›å»ºå¸ƒå±€
â‹®----
# åˆ›å»ºçª—å£
â‹®----
# å¾ªç¯è¯»å–äº‹ä»¶
â‹®----
# å¤„ç†ã€æ‰“å¼€ã€‘äº‹ä»¶
â‹®----
# å¤„ç†ã€æ»‘åŠ¨ã€‘äº‹ä»¶
â‹®----
# å¤„ç†ã€è¿è¡Œã€‘äº‹ä»¶
â‹®----
# å¦‚æœå…³é—­è½¯ä»¶ï¼Œé€€å‡º
â‹®----
# æ›´æ–°è¿›åº¦æ¡
â‹®----
# 1) æ‰“å¼€ä¿®æ”¹å­—å¹•æ»‘å—åŒºåŸŸæŒ‰é’®
â‹®----
# 2) æ‰“å¼€ã€è¿è¡Œã€‘ã€ã€æ‰“å¼€ã€‘å’Œã€è¯†åˆ«è¯­è¨€ã€‘æŒ‰é’®
â‹®----
# 1) å…³é—­ä¿®æ”¹å­—å¹•æ»‘å—åŒºåŸŸæŒ‰é’®
â‹®----
# 2) å…³é—­ã€è¿è¡Œã€‘ã€ã€æ‰“å¼€ã€‘å’Œã€è¯†åˆ«è¯­è¨€ã€‘æŒ‰é’®
â‹®----
def _create_layout(self)
â‹®----
"""
        åˆ›å»ºå­—å¹•æå–å™¨å¸ƒå±€
        """
garbage = os.path.join(os.path.dirname(__file__), 'output')
â‹®----
# æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
â‹®----
# æ‰“å¼€æŒ‰é’® + å¿«è¿›å¿«é€€æ¡
â‹®----
# è¾“å‡ºåŒºåŸŸ
â‹®----
# è¿è¡ŒæŒ‰é’® + è¿›åº¦æ¡
â‹®----
def _file_event_handler(self, event, values)
â‹®----
"""
        å½“ç‚¹å‡»æ‰“å¼€æŒ‰é’®æ—¶ï¼š
        1ï¼‰æ‰“å¼€è§†é¢‘æ–‡ä»¶ï¼Œå°†ç”»å¸ƒæ˜¾ç¤ºè§†é¢‘å¸§
        2ï¼‰è·å–è§†é¢‘ä¿¡æ¯ï¼Œåˆå§‹åŒ–è¿›åº¦æ¡æ»‘å—èŒƒå›´
        """
â‹®----
# è·å–è§†é¢‘çš„å¸§æ•°
â‹®----
# è·å–è§†é¢‘çš„é«˜åº¦
â‹®----
# è·å–è§†é¢‘çš„å®½åº¦
â‹®----
# è·å–è§†é¢‘çš„å¸§ç‡
â‹®----
# è°ƒæ•´è§†é¢‘å¸§å¤§å°ï¼Œä½¿æ’­æ”¾å™¨èƒ½å¤Ÿæ˜¾ç¤º
resized_frame = self._img_resize(frame)
# resized_frame = cv2.resize(src=frame, dsize=(self.video_preview_width, self.video_preview_height))
# æ˜¾ç¤ºè§†é¢‘å¸§
â‹®----
# æ›´æ–°è§†é¢‘è¿›åº¦æ¡æ»‘å—range
â‹®----
# é¢„è®¾å­—å¹•åŒºåŸŸä½ç½®
â‹®----
y = self.frame_height * y_p
h = self.frame_height * h_p
x = self.frame_width * x_p
w = self.frame_width * w_p
# æ›´æ–°è§†é¢‘å­—å¹•ä½ç½®æ»‘å—range
# æ›´æ–°Y-SLIDERèŒƒå›´
â‹®----
# æ›´æ–°Y-SLIDERé»˜è®¤å€¼
â‹®----
# æ›´æ–°X-SLIDERèŒƒå›´
â‹®----
# æ›´æ–°X-SLIDERé»˜è®¤å€¼
â‹®----
# æ›´æ–°Y-SLIDER-HèŒƒå›´
â‹®----
# æ›´æ–°Y-SLIDER-Hé»˜è®¤å€¼
â‹®----
# æ›´æ–°X-SLIDER-WèŒƒå›´
â‹®----
# æ›´æ–°X-SLIDER-Wé»˜è®¤å€¼
â‹®----
def __disable_button(self)
â‹®----
# 1) ç¦æ­¢ä¿®æ”¹å­—å¹•æ»‘å—åŒºåŸŸ
â‹®----
# 2) ç¦æ­¢å†æ¬¡ç‚¹å‡»ã€è¿è¡Œã€‘ã€ã€æ‰“å¼€ã€‘å’Œã€è¯†åˆ«è¯­è¨€ã€‘æŒ‰é’®
â‹®----
def _run_event_handler(self, event, values)
â‹®----
"""
        å½“ç‚¹å‡»è¿è¡ŒæŒ‰é’®æ—¶ï¼š
        1) ç¦æ­¢ä¿®æ”¹å­—å¹•æ»‘å—åŒºåŸŸ
        2) ç¦æ­¢å†æ¬¡ç‚¹å‡»ã€è¿è¡Œã€‘å’Œã€æ‰“å¼€ã€‘æŒ‰é’®
        3) è®¾å®šå­—å¹•åŒºåŸŸä½ç½®
        """
â‹®----
# ç¦ç”¨æŒ‰é’®
â‹®----
# 3) è®¾å®šå­—å¹•åŒºåŸŸä½ç½®
â‹®----
subtitle_area = (self.ymin, self.ymax, self.xmin, self.xmax)
â‹®----
# å…ˆåˆ¤æ–­æ¯ä¸ªè§†é¢‘çš„åˆ†è¾¨ç‡æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´çš„è¯è®¾ç½®ç›¸åŒçš„å­—å¹•åŒºåŸŸï¼Œå¦åˆ™è®¾ç½®ä¸ºNone
global_size = None
â‹®----
temp_cap = cv2.VideoCapture(temp_video_path)
â‹®----
global_size = (int(temp_cap.get(cv2.CAP_PROP_FRAME_WIDTH)), int(temp_cap.get(cv2.CAP_PROP_FRAME_HEIGHT)))
â‹®----
temp_size = (int(temp_cap.get(cv2.CAP_PROP_FRAME_WIDTH)), int(temp_cap.get(cv2.CAP_PROP_FRAME_HEIGHT)))
â‹®----
subtitle_area = None
â‹®----
y_p = self.ymin / self.frame_height
h_p = (self.ymax - self.ymin) / self.frame_height
x_p = self.xmin / self.frame_width
w_p = (self.xmax - self.xmin) / self.frame_width
â‹®----
def task()
â‹®----
video_path = self.video_paths.pop()
â‹®----
def _slide_event_handler(self, event, values)
â‹®----
"""
        å½“æ»‘åŠ¨è§†é¢‘è¿›åº¦æ¡/æ»‘åŠ¨å­—å¹•é€‰æ‹©åŒºåŸŸæ»‘å—æ—¶ï¼š
        1) åˆ¤æ–­è§†é¢‘æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ˜¾ç¤ºå¯¹åº”çš„è§†é¢‘å¸§
        2) ç»˜åˆ¶rectangle
        """
â‹®----
# åˆ¤æ–­æ˜¯å¦æ—¶å•å¼ å›¾ç‰‡
â‹®----
img = cv2.imread(self.video_path)
â‹®----
# ç”»å­—å¹•æ¡†
y = int(values['-Y-SLIDER-'])
h = int(values['-Y-SLIDER-H-'])
x = int(values['-X-SLIDER-'])
w = int(values['-X-SLIDER-W-'])
â‹®----
frame_no = int(values['-SLIDER-'])
â‹®----
def _update_preview(self, frame, y_h_x_w)
â‹®----
draw = cv2.rectangle(img=frame, pt1=(int(x), int(y)), pt2=(int(x) + int(w), int(y) + int(h)),
â‹®----
resized_frame = self._img_resize(draw)
â‹®----
def _img_resize(self, image)
â‹®----
# å¯¹é•¿çŸ­ä¸æƒ³ç­‰çš„å›¾ç‰‡ï¼Œæ‰¾åˆ°æœ€é•¿çš„ä¸€è¾¹
longest_edge = height
# è®¡ç®—çŸ­è¾¹éœ€è¦å¢åŠ å¤šå°‘åƒç´ å®½åº¦ä½¿å…¶ä¸é•¿è¾¹ç­‰é•¿
â‹®----
dw = longest_edge - width
left = dw // 2
right = dw - left
â‹®----
# ç»™å›¾åƒå¢åŠ è¾¹ç•Œ
constant = cv2.copyMakeBorder(image, top, bottom, left, right, cv2.BORDER_CONSTANT, value=[0, 0, 0])
â‹®----
def set_subtitle_config(self, y, h, x, w)
â‹®----
# å†™å…¥é…ç½®æ–‡ä»¶
â‹®----
def parse_subtitle_config(self)
â‹®----
# å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™å†™å…¥é…ç½®æ–‡ä»¶
â‹®----
config = configparser.ConfigParser()
â‹®----
# è¿è¡Œå›¾å½¢åŒ–ç•Œé¢
subtitleRemoverGUI = SubtitleRemoverGUI()
â‹®----
msg = traceback.format_exc()
err_log_path = os.path.join(os.path.expanduser('~'), 'VSR-Error-Message.log')
</file>

<file path="backend/inpaint/sttn_inpaint.py">
# å®šä¹‰å›¾åƒé¢„å¤„ç†æ–¹å¼
_to_tensors = transforms.Compose([
â‹®----
Stack(),  # å°†å›¾åƒå †å ä¸ºåºåˆ—
ToTorchFormatTensor()  # å°†å †å çš„å›¾åƒè½¬åŒ–ä¸ºPyTorchå¼ é‡
â‹®----
class STTNInpaint
â‹®----
def __init__(self)
â‹®----
# 1. åˆ›å»ºInpaintGeneratoræ¨¡å‹å®ä¾‹å¹¶è£…è½½åˆ°é€‰æ‹©çš„è®¾å¤‡ä¸Š
â‹®----
# 2. è½½å…¥é¢„è®­ç»ƒæ¨¡å‹çš„æƒé‡ï¼Œè½¬è½½æ¨¡å‹çš„çŠ¶æ€å­—å…¸
â‹®----
# 3. # å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼
â‹®----
# æ¨¡å‹è¾“å…¥ç”¨çš„å®½å’Œé«˜
â‹®----
# 2. è®¾ç½®ç›¸è¿å¸§æ•°
â‹®----
def __call__(self, input_frames: List[np.ndarray], input_mask: np.ndarray)
â‹®----
"""
        :param input_frames: åŸè§†é¢‘å¸§
        :param mask: å­—å¹•åŒºåŸŸmask
        """
â‹®----
mask = mask[:, :, None]
â‹®----
H_ori = int(H_ori + 0.5)
W_ori = int(W_ori + 0.5)
# ç¡®å®šå»å­—å¹•çš„å‚ç›´é«˜åº¦éƒ¨åˆ†
split_h = int(W_ori * 3 / 16)
inpaint_area = self.get_inpaint_area_by_mask(H_ori, split_h, mask)
# åˆå§‹åŒ–å¸§å­˜å‚¨å˜é‡
# é«˜åˆ†è¾¨ç‡å¸§å­˜å‚¨åˆ—è¡¨
frames_hr = copy.deepcopy(input_frames)
frames_scaled = {}  # å­˜æ”¾ç¼©æ”¾åå¸§çš„å­—å…¸
comps = {}  # å­˜æ”¾è¡¥å…¨åå¸§çš„å­—å…¸
# å­˜å‚¨æœ€ç»ˆçš„è§†é¢‘å¸§
inpainted_frames = []
â‹®----
frames_scaled[k] = []  # ä¸ºæ¯ä¸ªå»é™¤éƒ¨åˆ†åˆå§‹åŒ–ä¸€ä¸ªåˆ—è¡¨
â‹®----
# è¯»å–å¹¶ç¼©æ”¾å¸§
â‹®----
image = frames_hr[j]
# å¯¹æ¯ä¸ªå»é™¤éƒ¨åˆ†è¿›è¡Œåˆ‡å‰²å’Œç¼©æ”¾
â‹®----
image_crop = image[inpaint_area[k][0]:inpaint_area[k][1], :, :]  # åˆ‡å‰²
image_resize = cv2.resize(image_crop, (self.model_input_width, self.model_input_height))  # ç¼©æ”¾
frames_scaled[k].append(image_resize)  # å°†ç¼©æ”¾åçš„å¸§æ·»åŠ åˆ°å¯¹åº”åˆ—è¡¨
â‹®----
# å¤„ç†æ¯ä¸€ä¸ªå»é™¤éƒ¨åˆ†
â‹®----
# è°ƒç”¨inpaintå‡½æ•°è¿›è¡Œå¤„ç†
â‹®----
# å¦‚æœå­˜åœ¨å»é™¤éƒ¨åˆ†
â‹®----
frame = frames_hr[j]  # å–å‡ºåŸå§‹å¸§
# å¯¹äºæ¨¡å¼ä¸­çš„æ¯ä¸€ä¸ªæ®µè½
â‹®----
comp = cv2.resize(comps[k][j], (W_ori, split_h))  # å°†è¡¥å…¨å¸§ç¼©æ”¾å›åŸå¤§å°
comp = cv2.cvtColor(np.array(comp).astype(np.uint8), cv2.COLOR_BGR2RGB)  # è½¬æ¢é¢œè‰²ç©ºé—´
# è·å–é®ç½©åŒºåŸŸå¹¶è¿›è¡Œå›¾åƒåˆæˆ
mask_area = mask[inpaint_area[k][0]:inpaint_area[k][1], :]  # å–å‡ºé®ç½©åŒºåŸŸ
# å®ç°é®ç½©åŒºåŸŸå†…çš„å›¾åƒèåˆ
â‹®----
# å°†æœ€ç»ˆå¸§æ·»åŠ åˆ°åˆ—è¡¨
â‹®----
@staticmethod
    def read_mask(path)
â‹®----
img = cv2.imread(path, 0)
# è½¬ä¸ºbinary mask
â‹®----
img = img[:, :, None]
â‹®----
def get_ref_index(self, neighbor_ids, length)
â‹®----
"""
        é‡‡æ ·æ•´ä¸ªè§†é¢‘çš„å‚è€ƒå¸§
        """
# åˆå§‹åŒ–å‚è€ƒå¸§çš„ç´¢å¼•åˆ—è¡¨
ref_index = []
# åœ¨è§†é¢‘é•¿åº¦èŒƒå›´å†…æ ¹æ®ref_lengthé€æ­¥è¿­ä»£
â‹®----
# å¦‚æœå½“å‰å¸§ä¸åœ¨è¿‘é‚»å¸§ä¸­
â‹®----
# å°†å®ƒæ·»åŠ åˆ°å‚è€ƒå¸§åˆ—è¡¨
â‹®----
# è¿”å›å‚è€ƒå¸§ç´¢å¼•åˆ—è¡¨
â‹®----
def inpaint(self, frames: List[np.ndarray])
â‹®----
"""
        ä½¿ç”¨STTNå®Œæˆç©ºæ´å¡«å……ï¼ˆç©ºæ´å³è¢«é®ç½©çš„åŒºåŸŸï¼‰
        """
frame_length = len(frames)
# å¯¹å¸§è¿›è¡Œé¢„å¤„ç†è½¬æ¢ä¸ºå¼ é‡ï¼Œå¹¶è¿›è¡Œå½’ä¸€åŒ–
feats = _to_tensors(frames).unsqueeze(0) * 2 - 1
# æŠŠç‰¹å¾å¼ é‡è½¬ç§»åˆ°æŒ‡å®šçš„è®¾å¤‡ï¼ˆCPUæˆ–GPUï¼‰
feats = feats.to(self.device)
# åˆå§‹åŒ–ä¸€ä¸ªä¸è§†é¢‘é•¿åº¦ç›¸åŒçš„åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨å¤„ç†å®Œæˆçš„å¸§
comp_frames = [None] * frame_length
# å…³é—­æ¢¯åº¦è®¡ç®—ï¼Œç”¨äºæ¨ç†é˜¶æ®µèŠ‚çœå†…å­˜å¹¶åŠ é€Ÿ
â‹®----
# å°†å¤„ç†å¥½çš„å¸§é€šè¿‡ç¼–ç å™¨ï¼Œäº§ç”Ÿç‰¹å¾è¡¨ç¤º
feats = self.model.encoder(feats.view(frame_length, 3, self.model_input_height, self.model_input_width))
# è·å–ç‰¹å¾ç»´åº¦ä¿¡æ¯
â‹®----
# è°ƒæ•´ç‰¹å¾å½¢çŠ¶ä»¥åŒ¹é…æ¨¡å‹çš„æœŸæœ›è¾“å…¥
feats = feats.view(1, frame_length, c, feat_h, feat_w)
# è·å–é‡ç»˜åŒºåŸŸ
# åœ¨è®¾å®šçš„é‚»å±…å¸§æ­¥å¹…å†…å¾ªç¯å¤„ç†è§†é¢‘
â‹®----
# è®¡ç®—é‚»è¿‘å¸§çš„ID
neighbor_ids = [i for i in range(max(0, f - self.neighbor_stride), min(frame_length, f + self.neighbor_stride + 1))]
# è·å–å‚è€ƒå¸§çš„ç´¢å¼•
ref_ids = self.get_ref_index(neighbor_ids, frame_length)
# åŒæ ·å…³é—­æ¢¯åº¦è®¡ç®—
â‹®----
# é€šè¿‡æ¨¡å‹æ¨æ–­ç‰¹å¾å¹¶ä¼ é€’ç»™è§£ç å™¨ä»¥ç”Ÿæˆå®Œæˆçš„å¸§
pred_feat = self.model.infer(feats[0, neighbor_ids + ref_ids, :, :, :])
# å°†é¢„æµ‹çš„ç‰¹å¾é€šè¿‡è§£ç å™¨ç”Ÿæˆå›¾ç‰‡ï¼Œå¹¶åº”ç”¨æ¿€æ´»å‡½æ•°tanhï¼Œç„¶ååˆ†ç¦»å‡ºå¼ é‡
pred_img = torch.tanh(self.model.decoder(pred_feat[:len(neighbor_ids), :, :, :])).detach()
# å°†ç»“æœå¼ é‡é‡æ–°ç¼©æ”¾åˆ°0åˆ°255çš„èŒƒå›´å†…ï¼ˆå›¾åƒåƒç´ å€¼ï¼‰
pred_img = (pred_img + 1) / 2
# å°†å¼ é‡ç§»åŠ¨å›CPUå¹¶è½¬ä¸ºNumPyæ•°ç»„
pred_img = pred_img.cpu().permute(0, 2, 3, 1).numpy() * 255
# éå†é‚»è¿‘å¸§
â‹®----
idx = neighbor_ids[i]
# å°†é¢„æµ‹çš„å›¾ç‰‡è½¬æ¢ä¸ºæ— ç¬¦å·8ä½æ•´æ•°æ ¼å¼
img = np.array(pred_img[i]).astype(np.uint8)
â‹®----
# å¦‚æœè¯¥ä½ç½®ä¸ºç©ºï¼Œåˆ™èµ‹å€¼ä¸ºæ–°è®¡ç®—å‡ºçš„å›¾ç‰‡
â‹®----
# å¦‚æœæ­¤ä½ç½®ä¹‹å‰å·²æœ‰å›¾ç‰‡ï¼Œåˆ™å°†æ–°æ—§å›¾ç‰‡æ··åˆä»¥æé«˜è´¨é‡
â‹®----
# è¿”å›å¤„ç†å®Œæˆçš„å¸§åºåˆ—
â‹®----
@staticmethod
    def get_inpaint_area_by_mask(H, h, mask)
â‹®----
"""
        è·å–å­—å¹•å»é™¤åŒºåŸŸï¼Œæ ¹æ®maskæ¥ç¡®å®šéœ€è¦å¡«è¡¥çš„åŒºåŸŸå’Œé«˜åº¦
        """
# å­˜å‚¨ç»˜ç”»åŒºåŸŸçš„åˆ—è¡¨
inpaint_area = []
# ä»è§†é¢‘åº•éƒ¨çš„å­—å¹•ä½ç½®å¼€å§‹ï¼Œå‡è®¾å­—å¹•é€šå¸¸ä½äºåº•éƒ¨
to_H = from_H = H
# ä»åº•éƒ¨å‘ä¸Šéå†é®ç½©
â‹®----
# å¦‚æœä¸‹ä¸€æ®µä¼šè¶…å‡ºé¡¶ç«¯ï¼Œåˆ™ä»é¡¶ç«¯å¼€å§‹
from_H = 0
to_H = h
â‹®----
# ç¡®å®šæ®µçš„ä¸Šè¾¹ç•Œ
from_H = to_H - h
# æ£€æŸ¥å½“å‰æ®µè½æ˜¯å¦åŒ…å«é®ç½©åƒç´ 
â‹®----
# å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªæ®µè½ï¼Œå‘ä¸‹ç§»åŠ¨ä»¥ç¡®ä¿æ²¡é—æ¼é®ç½©åŒºåŸŸ
â‹®----
move = 0
â‹®----
# ç¡®ä¿æ²¡æœ‰è¶Šè¿‡åº•éƒ¨
â‹®----
# å°†è¯¥æ®µè½æ·»åŠ åˆ°åˆ—è¡¨ä¸­
â‹®----
# ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ®µè½
â‹®----
return inpaint_area  # è¿”å›ç»˜ç”»åŒºåŸŸåˆ—è¡¨
â‹®----
@staticmethod
    def get_inpaint_area_by_selection(input_sub_area, mask)
â‹®----
interval_size = 135
# å­˜å‚¨ç»“æœçš„åˆ—è¡¨
â‹®----
# è®¡ç®—å¹¶å­˜å‚¨æ ‡å‡†åŒºé—´
â‹®----
# æ£€æŸ¥æœ€åä¸€ä¸ªåŒºé—´æ˜¯å¦è¾¾åˆ°äº†æœ€å¤§å€¼
â‹®----
# å¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„åŒºé—´ï¼Œå¼€å§‹äºæœ€åä¸€ä¸ªåŒºé—´çš„ç»“æŸï¼Œç»“æŸäºæ‰©å¤§åçš„å€¼
â‹®----
class STTNVideoInpaint
â‹®----
def read_frame_info_from_video(self)
â‹®----
# ä½¿ç”¨opencvè¯»å–è§†é¢‘
reader = cv2.VideoCapture(self.video_path)
# è·å–è§†é¢‘çš„å®½åº¦, é«˜åº¦, å¸§ç‡å’Œå¸§æ•°ä¿¡æ¯å¹¶å­˜å‚¨åœ¨frame_infoå­—å…¸ä¸­
frame_info = {
â‹®----
'W_ori': int(reader.get(cv2.CAP_PROP_FRAME_WIDTH) + 0.5),  # è§†é¢‘çš„åŸå§‹å®½åº¦
'H_ori': int(reader.get(cv2.CAP_PROP_FRAME_HEIGHT) + 0.5),  # è§†é¢‘çš„åŸå§‹é«˜åº¦
'fps': reader.get(cv2.CAP_PROP_FPS),  # è§†é¢‘çš„å¸§ç‡
'len': int(reader.get(cv2.CAP_PROP_FRAME_COUNT) + 0.5)  # è§†é¢‘çš„æ€»å¸§æ•°
â‹®----
# è¿”å›è§†é¢‘è¯»å–å¯¹è±¡ã€å¸§ä¿¡æ¯å’Œè§†é¢‘å†™å…¥å¯¹è±¡
â‹®----
def __init__(self, video_path, mask_path=None, clip_gap=None)
â‹®----
# STTNInpaintè§†é¢‘ä¿®å¤å®ä¾‹åˆå§‹åŒ–
â‹®----
# è§†é¢‘å’Œæ©ç è·¯å¾„
â‹®----
# è®¾ç½®è¾“å‡ºè§†é¢‘æ–‡ä»¶çš„è·¯å¾„
â‹®----
# é…ç½®å¯åœ¨ä¸€æ¬¡å¤„ç†ä¸­åŠ è½½çš„æœ€å¤§å¸§æ•°
â‹®----
def __call__(self, input_mask=None, input_sub_remover=None, tbar=None)
â‹®----
reader = None
writer = None
â‹®----
# è¯»å–è§†é¢‘å¸§ä¿¡æ¯
â‹®----
writer = input_sub_remover.video_writer
â‹®----
# åˆ›å»ºè§†é¢‘å†™å…¥å¯¹è±¡ï¼Œç”¨äºè¾“å‡ºä¿®å¤åçš„è§†é¢‘
writer = cv2.VideoWriter(self.video_out_path, cv2.VideoWriter_fourcc(*"mp4v"), frame_info['fps'], (frame_info['W_ori'], frame_info['H_ori']))
â‹®----
# è®¡ç®—éœ€è¦è¿­ä»£ä¿®å¤è§†é¢‘çš„æ¬¡æ•°
rec_time = frame_info['len'] // self.clip_gap if frame_info['len'] % self.clip_gap == 0 else frame_info['len'] // self.clip_gap + 1
# è®¡ç®—åˆ†å‰²é«˜åº¦ï¼Œç”¨äºç¡®å®šä¿®å¤åŒºåŸŸçš„å¤§å°
split_h = int(frame_info['W_ori'] * 3 / 16)
â‹®----
# è¯»å–æ©ç 
mask = self.sttn_inpaint.read_mask(self.mask_path)
â‹®----
# å¾—åˆ°ä¿®å¤åŒºåŸŸä½ç½®
inpaint_area = self.sttn_inpaint.get_inpaint_area_by_mask(frame_info['H_ori'], split_h, mask)
â‹®----
# éå†æ¯ä¸€æ¬¡çš„è¿­ä»£æ¬¡æ•°
â‹®----
start_f = i * self.clip_gap  # èµ·å§‹å¸§ä½ç½®
end_f = min((i + 1) * self.clip_gap, frame_info['len'])  # ç»“æŸå¸§ä½ç½®
â‹®----
frames_hr = []  # é«˜åˆ†è¾¨ç‡å¸§åˆ—è¡¨
frames = {}  # å¸§å­—å…¸ï¼Œç”¨äºå­˜å‚¨è£å‰ªåçš„å›¾åƒ
comps = {}  # ç»„åˆå­—å…¸ï¼Œç”¨äºå­˜å‚¨ä¿®å¤åçš„å›¾åƒ
â‹®----
# åˆå§‹åŒ–å¸§å­—å…¸
â‹®----
# è¯»å–å’Œä¿®å¤é«˜åˆ†è¾¨ç‡å¸§
valid_frames_count = 0
â‹®----
# è£å‰ªã€ç¼©æ”¾å¹¶æ·»åŠ åˆ°å¸§å­—å…¸
image_crop = image[inpaint_area[k][0]:inpaint_area[k][1], :, :]
image_resize = cv2.resize(image_crop, (self.sttn_inpaint.model_input_width, self.sttn_inpaint.model_input_height))
â‹®----
# å¦‚æœæ²¡æœ‰è¯»å–åˆ°æœ‰æ•ˆå¸§ï¼Œåˆ™è·³è¿‡å½“å‰è¿­ä»£
â‹®----
# å¯¹æ¯ä¸ªä¿®å¤åŒºåŸŸè¿è¡Œä¿®å¤
â‹®----
if len(frames[k]) > 0:  # ç¡®ä¿æœ‰å¸§å¯ä»¥å¤„ç†
â‹®----
# å¦‚æœæœ‰è¦ä¿®å¤çš„åŒºåŸŸ
â‹®----
original_frame = copy.deepcopy(frames_hr[j])
â‹®----
original_frame = None
â‹®----
frame = frames_hr[j]
â‹®----
if j < len(comps[k]):  # ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
# å°†ä¿®å¤çš„å›¾åƒé‡æ–°æ‰©å±•åˆ°åŸå§‹åˆ†è¾¨ç‡ï¼Œå¹¶èåˆåˆ°åŸå§‹å¸§
comp = cv2.resize(comps[k][j], (frame_info['W_ori'], split_h))
comp = cv2.cvtColor(np.array(comp).astype(np.uint8), cv2.COLOR_BGR2RGB)
mask_area = mask[inpaint_area[k][0]:inpaint_area[k][1], :]
â‹®----
# ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œå…è®¸ç¨‹åºç»§ç»­æ‰§è¡Œ
â‹®----
mask_path = '../../test/test.png'
video_path = '../../test/test.mp4'
# è®°å½•å¼€å§‹æ—¶é—´
start = time.time()
sttn_video_inpaint = STTNVideoInpaint(video_path, mask_path, clip_gap=config.STTN_MAX_LOAD_NUM)
</file>

<file path="backend/config.py">
# é¡¹ç›®ç‰ˆæœ¬å·
VERSION = "1.1.1"
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— [ä¸è¦æ”¹] start Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
logging.disable(logging.DEBUG)  # å…³é—­DEBUGæ—¥å¿—çš„æ‰“å°
logging.disable(logging.WARNING)  # å…³é—­WARNINGæ—¥å¿—çš„æ‰“å°
â‹®----
device = torch_directml.device(torch_directml.default_device())
USE_DML = True
â‹®----
USE_DML = False
device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu")
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
LAMA_MODEL_PATH = os.path.join(BASE_DIR, 'models', 'big-lama')
STTN_MODEL_PATH = os.path.join(BASE_DIR, 'models', 'sttn', 'infer_model.pth')
VIDEO_INPAINT_MODEL_PATH = os.path.join(BASE_DIR, 'models', 'video')
MODEL_VERSION = 'V4'
DET_MODEL_BASE = os.path.join(BASE_DIR, 'models')
DET_MODEL_PATH = os.path.join(DET_MODEL_BASE, MODEL_VERSION, 'ch_det')
â‹®----
# æŸ¥çœ‹è¯¥è·¯å¾„ä¸‹æ˜¯å¦æœ‰æ¨¡å‹å®Œæ•´æ–‡ä»¶ï¼Œæ²¡æœ‰çš„è¯åˆå¹¶å°æ–‡ä»¶ç”Ÿæˆå®Œæ•´æ–‡ä»¶
â‹®----
fs = Filesplit()
â‹®----
# æŒ‡å®šffmpegå¯æ‰§è¡Œç¨‹åºè·¯å¾„
sys_str = platform.system()
â‹®----
ffmpeg_bin = os.path.join('win_x64', 'ffmpeg.exe')
â‹®----
ffmpeg_bin = os.path.join('linux_x64', 'ffmpeg')
â‹®----
ffmpeg_bin = os.path.join('macos', 'ffmpeg')
FFMPEG_PATH = os.path.join(BASE_DIR, '', 'ffmpeg', ffmpeg_bin)
â‹®----
# å°†ffmpegæ·»åŠ å¯æ‰§è¡Œæƒé™
â‹®----
# æ˜¯å¦ä½¿ç”¨ONNX(DirectML/AMD/Intel)
ONNX_PROVIDERS = []
available_providers = ort.get_available_providers()
â‹®----
"DmlExecutionProvider",         # DirectMLï¼Œé€‚ç”¨äº Windows GPU
"ROCMExecutionProvider",        # AMD ROCm
"MIGraphXExecutionProvider",    # AMD MIGraphX
"VitisAIExecutionProvider",     # AMD VitisAIï¼Œé€‚ç”¨äº RyzenAI & Windows, å®æµ‹å’ŒDirectMLæ€§èƒ½ä¼¼ä¹å·®ä¸å¤š
"OpenVINOExecutionProvider",    # Intel GPU
"MetalExecutionProvider",       # Apple macOS
"CoreMLExecutionProvider",      # Apple macOS
"CUDAExecutionProvider",        # Nvidia GPU
â‹®----
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— [ä¸è¦æ”¹] end Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
â‹®----
@unique
class InpaintMode(Enum)
â‹®----
"""
    å›¾åƒé‡ç»˜ç®—æ³•æšä¸¾
    """
STTN = 'sttn'
LAMA = 'lama'
PROPAINTER = 'propainter'
â‹®----
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— [å¯ä»¥æ”¹] start Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
# æ˜¯å¦ä½¿ç”¨h264ç¼–ç ï¼Œå¦‚æœéœ€è¦å®‰å“æ‰‹æœºåˆ†äº«ç”Ÿæˆçš„è§†é¢‘ï¼Œè¯·æ‰“å¼€è¯¥é€‰é¡¹
USE_H264 = True
â‹®----
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— é€šç”¨è®¾ç½® start Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
"""
MODEå¯é€‰ç®—æ³•ç±»å‹
- InpaintMode.STTN ç®—æ³•ï¼šå¯¹äºçœŸäººè§†é¢‘æ•ˆæœè¾ƒå¥½ï¼Œé€Ÿåº¦å¿«ï¼Œå¯ä»¥è·³è¿‡å­—å¹•æ£€æµ‹
- InpaintMode.LAMA ç®—æ³•ï¼šå¯¹äºåŠ¨ç”»ç±»è§†é¢‘æ•ˆæœå¥½ï¼Œé€Ÿåº¦ä¸€èˆ¬ï¼Œä¸å¯ä»¥è·³è¿‡å­—å¹•æ£€æµ‹
- InpaintMode.PROPAINTER ç®—æ³•ï¼š éœ€è¦æ¶ˆè€—å¤§é‡æ˜¾å­˜ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œå¯¹è¿åŠ¨éå¸¸å‰§çƒˆçš„è§†é¢‘æ•ˆæœè¾ƒå¥½
"""
# ã€è®¾ç½®inpaintç®—æ³•ã€‘
MODE = InpaintMode.STTN
# ã€è®¾ç½®åƒç´ ç‚¹åå·®ã€‘
# ç”¨äºåˆ¤æ–­æ˜¯ä¸æ˜¯éå­—å¹•åŒºåŸŸ(ä¸€èˆ¬è®¤ä¸ºå­—å¹•æ–‡æœ¬æ¡†çš„é•¿åº¦æ˜¯è¦å¤§äºå®½åº¦çš„ï¼Œå¦‚æœå­—å¹•æ¡†çš„é«˜å¤§äºå®½ï¼Œä¸”å¤§äºçš„å¹…åº¦è¶…è¿‡æŒ‡å®šåƒç´ ç‚¹å¤§å°ï¼Œåˆ™è®¤ä¸ºæ˜¯é”™è¯¯æ£€æµ‹)
THRESHOLD_HEIGHT_WIDTH_DIFFERENCE = 10
# ç”¨äºæ”¾å¤§maskå¤§å°ï¼Œé˜²æ­¢è‡ªåŠ¨æ£€æµ‹çš„æ–‡æœ¬æ¡†è¿‡å°ï¼Œinpainté˜¶æ®µå‡ºç°æ–‡å­—è¾¹ï¼Œæœ‰æ®‹ç•™
SUBTITLE_AREA_DEVIATION_PIXEL = 20
# åŒäºåˆ¤æ–­ä¸¤ä¸ªæ–‡æœ¬æ¡†æ˜¯å¦ä¸ºåŒä¸€è¡Œå­—å¹•ï¼Œé«˜åº¦å·®è·æŒ‡å®šåƒç´ ç‚¹ä»¥å†…è®¤ä¸ºæ˜¯åŒä¸€è¡Œ
THRESHOLD_HEIGHT_DIFFERENCE = 20
# ç”¨äºåˆ¤æ–­ä¸¤ä¸ªå­—å¹•æ–‡æœ¬çš„çŸ©å½¢æ¡†æ˜¯å¦ç›¸ä¼¼ï¼Œå¦‚æœXè½´å’ŒYè½´åå·®éƒ½åœ¨æŒ‡å®šé˜ˆå€¼å†…ï¼Œåˆ™è®¤ä¸ºæ—¶åŒä¸€ä¸ªæ–‡æœ¬æ¡†
PIXEL_TOLERANCE_Y = 20  # å…è®¸æ£€æµ‹æ¡†çºµå‘åå·®çš„åƒç´ ç‚¹æ•°
PIXEL_TOLERANCE_X = 20  # å…è®¸æ£€æµ‹æ¡†æ¨ªå‘åå·®çš„åƒç´ ç‚¹æ•°
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— é€šç”¨è®¾ç½® end Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
â‹®----
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— InpaintMode.STTNç®—æ³•è®¾ç½® start Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
# ä»¥ä¸‹å‚æ•°ä»…é€‚ç”¨STTNç®—æ³•æ—¶ï¼Œæ‰ç”Ÿæ•ˆ
"""
1. STTN_SKIP_DETECTION
å«ä¹‰ï¼šæ˜¯å¦ä½¿ç”¨è·³è¿‡æ£€æµ‹
æ•ˆæœï¼šè®¾ç½®ä¸ºTrueè·³è¿‡å­—å¹•æ£€æµ‹ï¼Œä¼šçœå»å¾ˆå¤§æ—¶é—´ï¼Œä½†æ˜¯å¯èƒ½è¯¯ä¼¤æ— å­—å¹•çš„è§†é¢‘å¸§æˆ–è€…ä¼šå¯¼è‡´å»é™¤çš„å­—å¹•æ¼äº†

2. STTN_NEIGHBOR_STRIDE
å«ä¹‰ï¼šç›¸é‚»å¸§æ•°æ­¥é•¿, å¦‚æœéœ€è¦ä¸ºç¬¬50å¸§å¡«å……ç¼ºå¤±çš„åŒºåŸŸï¼ŒSTTN_NEIGHBOR_STRIDE=5ï¼Œé‚£ä¹ˆç®—æ³•ä¼šä½¿ç”¨ç¬¬45å¸§ã€ç¬¬40å¸§ç­‰ä½œä¸ºå‚ç…§ã€‚
æ•ˆæœï¼šç”¨äºæ§åˆ¶å‚è€ƒå¸§é€‰æ‹©çš„å¯†åº¦ï¼Œè¾ƒå¤§çš„æ­¥é•¿æ„å‘³ç€ä½¿ç”¨æ›´å°‘ã€æ›´åˆ†æ•£çš„å‚è€ƒå¸§ï¼Œè¾ƒå°çš„æ­¥é•¿æ„å‘³ç€ä½¿ç”¨æ›´å¤šã€æ›´é›†ä¸­çš„å‚è€ƒå¸§ã€‚

3. STTN_REFERENCE_LENGTH
å«ä¹‰ï¼šå‚æ•°å¸§æ•°é‡ï¼ŒSTTNç®—æ³•ä¼šæŸ¥çœ‹æ¯ä¸ªå¾…ä¿®å¤å¸§çš„å‰åè‹¥å¹²å¸§æ¥è·å¾—ç”¨äºä¿®å¤çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
æ•ˆæœï¼šè°ƒå¤§ä¼šå¢åŠ æ˜¾å­˜å ç”¨ï¼Œå¤„ç†æ•ˆæœå˜å¥½ï¼Œä½†æ˜¯å¤„ç†é€Ÿåº¦å˜æ…¢

4. STTN_MAX_LOAD_NUM
å«ä¹‰ï¼šSTTNç®—æ³•æ¯æ¬¡æœ€å¤šåŠ è½½çš„è§†é¢‘å¸§æ•°é‡
æ•ˆæœï¼šè®¾ç½®è¶Šå¤§é€Ÿåº¦è¶Šæ…¢ï¼Œä½†æ•ˆæœè¶Šå¥½
æ³¨æ„ï¼šè¦ä¿è¯STTN_MAX_LOAD_NUMå¤§äºSTTN_NEIGHBOR_STRIDEå’ŒSTTN_REFERENCE_LENGTH
"""
STTN_SKIP_DETECTION = True
# å‚è€ƒå¸§æ­¥é•¿
STTN_NEIGHBOR_STRIDE = 5
# å‚è€ƒå¸§é•¿åº¦ï¼ˆæ•°é‡ï¼‰
STTN_REFERENCE_LENGTH = 10
# è®¾ç½®STTNç®—æ³•æœ€å¤§åŒæ—¶å¤„ç†çš„å¸§æ•°é‡
STTN_MAX_LOAD_NUM = 50
â‹®----
STTN_MAX_LOAD_NUM = STTN_REFERENCE_LENGTH * STTN_NEIGHBOR_STRIDE
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— InpaintMode.STTNç®—æ³•è®¾ç½® end Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
â‹®----
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— InpaintMode.PROPAINTERç®—æ³•è®¾ç½® start Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
# ã€æ ¹æ®è‡ªå·±çš„GPUæ˜¾å­˜å¤§å°è®¾ç½®ã€‘æœ€å¤§åŒæ—¶å¤„ç†çš„å›¾ç‰‡æ•°é‡ï¼Œè®¾ç½®è¶Šå¤§å¤„ç†æ•ˆæœè¶Šå¥½ï¼Œä½†æ˜¯è¦æ±‚æ˜¾å­˜è¶Šé«˜
# 1280x720pè§†é¢‘è®¾ç½®80éœ€è¦25Gæ˜¾å­˜ï¼Œè®¾ç½®50éœ€è¦19Gæ˜¾å­˜
# 720x480pè§†é¢‘è®¾ç½®80éœ€è¦8Gæ˜¾å­˜ï¼Œè®¾ç½®50éœ€è¦7Gæ˜¾å­˜
PROPAINTER_MAX_LOAD_NUM = 70
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— InpaintMode.PROPAINTERç®—æ³•è®¾ç½® end Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
â‹®----
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— InpaintMode.LAMAç®—æ³•è®¾ç½® start Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
# æ˜¯å¦å¼€å¯æé€Ÿæ¨¡å¼ï¼Œå¼€å¯åä¸ä¿è¯inpaintæ•ˆæœï¼Œä»…ä»…å¯¹åŒ…å«æ–‡æœ¬çš„åŒºåŸŸæ–‡æœ¬è¿›è¡Œå»é™¤
LAMA_SUPER_FAST = False
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— InpaintMode.LAMAç®—æ³•è®¾ç½® end Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
# Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã— [å¯ä»¥æ”¹] end Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—
</file>

<file path="backend/main.py">
class SubtitleDetect
â‹®----
"""
    æ–‡æœ¬æ¡†æ£€æµ‹ç±»ï¼Œç”¨äºæ£€æµ‹è§†é¢‘å¸§ä¸­æ˜¯å¦å­˜åœ¨æ–‡æœ¬æ¡†
    """
â‹®----
def __init__(self, video_path, sub_area=None)
â‹®----
@cached_property
    def text_detector(self)
â‹®----
# è·å–å‚æ•°å¯¹è±¡
â‹®----
args = utility.parse_args()
â‹®----
def detect_subtitle(self, img)
â‹®----
@staticmethod
    def get_coordinates(dt_box)
â‹®----
"""
        ä»è¿”å›çš„æ£€æµ‹æ¡†ä¸­è·å–åæ ‡
        :param dt_box æ£€æµ‹æ¡†è¿”å›ç»“æœ
        :return list åæ ‡ç‚¹åˆ—è¡¨
        """
coordinate_list = list()
â‹®----
i = list(i)
â‹®----
xmin = max(x1, x4)
xmax = min(x2, x3)
ymin = max(y1, y2)
ymax = min(y3, y4)
â‹®----
def find_subtitle_frame_no(self, sub_remover=None)
â‹®----
video_cap = cv2.VideoCapture(self.video_path)
frame_count = video_cap.get(cv2.CAP_PROP_FRAME_COUNT)
tbar = tqdm(total=int(frame_count), unit='frame', position=0, file=sys.__stdout__, desc='Subtitle Finding')
current_frame_no = 0
subtitle_frame_no_box_dict = {}
â‹®----
# å¦‚æœè¯»å–è§†é¢‘å¸§å¤±è´¥ï¼ˆè§†é¢‘è¯»åˆ°æœ€åä¸€å¸§ï¼‰
â‹®----
# è¯»å–è§†é¢‘å¸§æˆåŠŸ
â‹®----
coordinate_list = self.get_coordinates(dt_boxes.tolist())
â‹®----
temp_list = []
â‹®----
subtitle_frame_no_box_dict = self.unify_regions(subtitle_frame_no_box_dict)
# if config.UNITE_COORDINATES:
#     subtitle_frame_no_box_dict = self.get_subtitle_frame_no_box_dict_with_united_coordinates(subtitle_frame_no_box_dict)
#     if sub_remover is not None:
#         try:
#             # å½“å¸§æ•°å¤§äº1æ—¶ï¼Œè¯´æ˜å¹¶éå›¾ç‰‡æˆ–å•å¸§
#             if sub_remover.frame_count > 1:
#                 subtitle_frame_no_box_dict = self.filter_mistake_sub_area(subtitle_frame_no_box_dict,
#                                                                           sub_remover.fps)
#         except Exception:
#             pass
#     subtitle_frame_no_box_dict = self.prevent_missed_detection(subtitle_frame_no_box_dict)
â‹®----
new_subtitle_frame_no_box_dict = dict()
â‹®----
def convertToOnnxModelIfNeeded(self, model_dir, model_filename="inference.pdmodel", params_filename="inference.pdiparams", opset_version=14)
â‹®----
"""Converts a Paddle model to ONNX if ONNX providers are available and the model does not already exist."""
â‹®----
onnx_model_path = os.path.join(model_dir, "model.onnx")
â‹®----
model_file = os.path.join(model_dir, model_filename)
params_file = os.path.join(model_dir, params_filename) if params_filename else ""
â‹®----
# Ensure the target directory exists
â‹®----
# Convert and save the model
onnx_model = paddle2onnx.export(
â‹®----
@staticmethod
    def split_range_by_scene(intervals, points)
â‹®----
# ç¡®ä¿ç¦»æ•£å€¼åˆ—è¡¨æ˜¯æœ‰åºçš„
â‹®----
# ç”¨äºå­˜å‚¨ç»“æœåŒºé—´çš„åˆ—è¡¨
result_intervals = []
# éå†åŒºé—´
â‹®----
# åœ¨å½“å‰åŒºé—´å†…çš„ç‚¹
current_points = [p for p in points if start <= p <= end]
â‹®----
# éå†å½“å‰åŒºé—´å†…çš„ç¦»æ•£ç‚¹
â‹®----
# å¦‚æœå½“å‰ç¦»æ•£ç‚¹ä¸æ˜¯åŒºé—´çš„èµ·å§‹ç‚¹ï¼Œæ·»åŠ ä»åŒºé—´å¼€å§‹åˆ°ç¦»æ•£ç‚¹å‰ä¸€ä¸ªæ•°å­—çš„åŒºé—´
â‹®----
# æ›´æ–°åŒºé—´å¼€å§‹ä¸ºå½“å‰ç¦»æ•£ç‚¹
start = p
# æ·»åŠ ä»æœ€åä¸€ä¸ªç¦»æ•£ç‚¹æˆ–åŒºé—´å¼€å§‹åˆ°åŒºé—´ç»“æŸçš„åŒºé—´
â‹®----
# è¾“å‡ºç»“æœ
â‹®----
@staticmethod
    def get_scene_div_frame_no(v_path)
â‹®----
"""
        è·å–å‘ç”Ÿåœºæ™¯åˆ‡æ¢çš„å¸§å·
        """
scene_div_frame_no_list = []
scene_list = scene_detect(v_path, ContentDetector())
â‹®----
@staticmethod
    def are_similar(region1, region2)
â‹®----
"""åˆ¤æ–­ä¸¤ä¸ªåŒºåŸŸæ˜¯å¦ç›¸ä¼¼ã€‚"""
â‹®----
def unify_regions(self, raw_regions)
â‹®----
"""å°†è¿ç»­ç›¸ä¼¼çš„åŒºåŸŸç»Ÿä¸€ï¼Œä¿æŒåˆ—è¡¨ç»“æ„ã€‚"""
â‹®----
keys = sorted(raw_regions.keys())  # å¯¹é”®è¿›è¡Œæ’åºä»¥ç¡®ä¿å®ƒä»¬æ˜¯è¿ç»­çš„
unified_regions = {}
â‹®----
# åˆå§‹åŒ–
last_key = keys[0]
unify_value_map = {last_key: raw_regions[last_key]}
â‹®----
current_regions = raw_regions[key]
â‹®----
# æ–°å¢ä¸€ä¸ªåˆ—è¡¨æ¥å­˜æ”¾åŒ¹é…è¿‡çš„æ ‡å‡†åŒºé—´
new_unify_values = []
â‹®----
last_standard_region = unify_value_map[last_key][idx] if idx < len(unify_value_map[last_key]) else None
â‹®----
# å¦‚æœå½“å‰çš„åŒºé—´ä¸å‰ä¸€ä¸ªé”®çš„å¯¹åº”åŒºé—´ç›¸ä¼¼ï¼Œæˆ‘ä»¬ç»Ÿä¸€å®ƒä»¬
â‹®----
# æ›´æ–°unify_value_mapä¸ºæœ€æ–°çš„åŒºé—´å€¼
â‹®----
last_key = key
â‹®----
# å°†æœ€ç»ˆç»Ÿä¸€åçš„ç»“æœä¼ é€’ç»™unified_regions
â‹®----
@staticmethod
    def find_continuous_ranges(subtitle_frame_no_box_dict)
â‹®----
"""
        è·å–å­—å¹•å‡ºç°çš„èµ·å§‹å¸§å·ä¸ç»“æŸå¸§å·
        """
numbers = sorted(list(subtitle_frame_no_box_dict.keys()))
ranges = []
start = numbers[0]  # åˆå§‹åŒºé—´å¼€å§‹å€¼
â‹®----
# å¦‚æœå½“å‰æ•°å­—ä¸å‰ä¸€ä¸ªæ•°å­—é—´éš”è¶…è¿‡1ï¼Œ
# åˆ™ä¸Šä¸€ä¸ªåŒºé—´ç»“æŸï¼Œè®°å½•å½“å‰åŒºé—´çš„å¼€å§‹ä¸ç»“æŸ
â‹®----
end = numbers[i - 1]  # åˆ™è¯¥æ•°å­—æ˜¯å½“å‰è¿ç»­åŒºé—´çš„ç»ˆç‚¹
â‹®----
start = numbers[i]  # å¼€å§‹ä¸‹ä¸€ä¸ªè¿ç»­åŒºé—´
# æ·»åŠ æœ€åä¸€ä¸ªåŒºé—´
â‹®----
@staticmethod
    def find_continuous_ranges_with_same_mask(subtitle_frame_no_box_dict)
â‹®----
# å¦‚æœå½“å‰å¸§å·ä¸å‰ä¸€ä¸ªå¸§å·é—´éš”è¶…è¿‡1ï¼Œ
â‹®----
# å¦‚æœå½“å‰å¸§å·ä¸å‰ä¸€ä¸ªå¸§å·é—´éš”ä¸º1ï¼Œä¸”å½“å‰å¸§å·å¯¹åº”çš„åæ ‡ç‚¹ä¸ä¸Šä¸€å¸§å·å¯¹åº”çš„åæ ‡ç‚¹ä¸ä¸€è‡´
# è®°å½•å½“å‰åŒºé—´çš„å¼€å§‹ä¸ç»“æŸ
â‹®----
@staticmethod
    def sub_area_to_polygon(sub_area)
â‹®----
"""
        xmin, xmax, ymin, ymax = sub_area
        """
s_xmin = sub_area[0]
s_xmax = sub_area[1]
s_ymin = sub_area[2]
s_ymax = sub_area[3]
â‹®----
@staticmethod
    def expand_and_merge_intervals(intervals, expand_size=config.STTN_NEIGHBOR_STRIDE*config.STTN_REFERENCE_LENGTH, max_length=config.STTN_MAX_LOAD_NUM)
â‹®----
# åˆå§‹åŒ–è¾“å‡ºåŒºé—´åˆ—è¡¨
expanded_intervals = []
â‹®----
# å¯¹æ¯ä¸ªåŸå§‹åŒºé—´è¿›è¡Œæ‰©å±•
â‹®----
# æ‰©å±•è‡³è‡³å°‘ 'expand_size' ä¸ªå•ä½ï¼Œä½†ä¸è¶…è¿‡ 'max_length' ä¸ªå•ä½
expansion_amount = max(expand_size - (end - start + 1), 0)
â‹®----
# åœ¨ä¿è¯åŒ…å«åŸåŒºé—´çš„å‰æä¸‹å°½å¯èƒ½å¹³åˆ†å‰åæ‰©å±•é‡
expand_start = max(start - expansion_amount // 2, 1)  # ç¡®ä¿èµ·å§‹ç‚¹ä¸å°äº1
expand_end = end + expansion_amount // 2
â‹®----
# å¦‚æœæ‰©å±•åçš„åŒºé—´è¶…å‡ºäº†æœ€å¤§é•¿åº¦ï¼Œè¿›è¡Œè°ƒæ•´
â‹®----
expand_end = expand_start + max_length - 1
â‹®----
# å¯¹äºå•ç‚¹çš„å¤„ç†ï¼Œéœ€é¢å¤–ä¿è¯æœ‰è‡³å°‘ 'expand_size' é•¿åº¦
â‹®----
expand_end = expand_start + expand_size - 1
â‹®----
# æ£€æŸ¥ä¸å‰ä¸€ä¸ªåŒºé—´æ˜¯å¦æœ‰é‡å å¹¶è¿›è¡Œç›¸åº”çš„åˆå¹¶
â‹®----
expand_start = previous_start
expand_end = max(expand_end, previous_end)
â‹®----
# æ·»åŠ æ‰©å±•åçš„åŒºé—´è‡³ç»“æœåˆ—è¡¨
â‹®----
@staticmethod
    def filter_and_merge_intervals(intervals, target_length=config.STTN_REFERENCE_LENGTH)
â‹®----
"""
        åˆå¹¶ä¼ å…¥çš„å­—å¹•èµ·å§‹åŒºé—´ï¼Œç¡®ä¿åŒºé—´å¤§å°æœ€ä½ä¸ºSTTN_REFERENCE_LENGTH
        """
expanded = []
# é¦–å…ˆå•ç‹¬å¤„ç†å•ç‚¹åŒºé—´ä»¥æ‰©å±•å®ƒä»¬
â‹®----
if start == end:  # å•ç‚¹åŒºé—´
# æ‰©å±•åˆ°æ¥è¿‘çš„ç›®æ ‡é•¿åº¦ï¼Œä½†ä¿è¯å‰åä¸é‡å 
prev_end = expanded[-1][1] if expanded else float('-inf')
next_start = float('inf')
# æŸ¥æ‰¾ä¸‹ä¸€ä¸ªåŒºé—´çš„èµ·å§‹ç‚¹
â‹®----
next_start = ns
â‹®----
# ç¡®å®šæ–°çš„æ‰©å±•èµ·ç‚¹å’Œç»ˆç‚¹
new_start = max(start - (target_length - 1) // 2, prev_end + 1)
new_end = min(start + (target_length - 1) // 2, next_start - 1)
# å¦‚æœæ–°çš„æ‰©å±•ç»ˆç‚¹åœ¨èµ·ç‚¹å‰é¢ï¼Œè¯´æ˜æ²¡æœ‰è¶³å¤Ÿç©ºé—´æ¥è¿›è¡Œæ‰©å±•
â‹®----
new_start, new_end = start, start  # ä¿æŒåŸæ ·
â‹®----
# éå•ç‚¹åŒºé—´ç›´æ¥ä¿ç•™ï¼Œç¨åå¤„ç†ä»»ä½•å¯èƒ½çš„é‡å 
â‹®----
# æ’åºä»¥åˆå¹¶é‚£äº›å› æ‰©å±•å¯¼è‡´é‡å çš„åŒºé—´
â‹®----
# åˆå¹¶é‡å çš„åŒºé—´ï¼Œä½†ä»…å½“å®ƒä»¬ä¹‹é—´çœŸæ­£é‡å ä¸”å°äºç›®æ ‡é•¿åº¦æ—¶
merged = [expanded[0]]
â‹®----
# æ£€æŸ¥æ˜¯å¦é‡å 
â‹®----
# éœ€è¦åˆå¹¶
merged[-1] = (last_start, max(last_end, end))  # åˆå¹¶åŒºé—´
â‹®----
# ç›¸é‚»åŒºé—´ä¹Ÿéœ€è¦åˆå¹¶çš„åœºæ™¯
â‹®----
# å¦‚æœæ²¡æœ‰é‡å ä¸”éƒ½å¤§äºç›®æ ‡é•¿åº¦ï¼Œåˆ™ç›´æ¥ä¿ç•™
â‹®----
def compute_iou(self, box1, box2)
â‹®----
box1_polygon = self.sub_area_to_polygon(box1)
box2_polygon = self.sub_area_to_polygon(box2)
intersection = box1_polygon.intersection(box2_polygon)
â‹®----
union_area = (box1_polygon.area + box2_polygon.area - intersection.area)
â‹®----
intersection_area_rate = intersection.area / union_area
â‹®----
intersection_area_rate = 0
â‹®----
def get_area_max_box_dict(self, sub_frame_no_list_continuous, subtitle_frame_no_box_dict)
â‹®----
_area_max_box_dict = dict()
â‹®----
# å¯»æ‰¾é¢ç§¯æœ€å¤§æ–‡æœ¬æ¡†
current_no = start_no
# æŸ¥æ‰¾å½“å‰åŒºé—´çŸ©å½¢æ¡†æœ€å¤§é¢ç§¯
area_max_box_list = []
â‹®----
# å–å‡ºæ¯ä¸€ä¸ªæ–‡æœ¬æ¡†åæ ‡
â‹®----
# è®¡ç®—å½“å‰æ–‡æœ¬æ¡†åæ ‡é¢ç§¯
current_area = abs(xmax - xmin) * abs(ymax - ymin)
# å¦‚æœåŒºé—´æœ€å¤§æ¡†åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™å½“å‰é¢ç§¯ä¸ºåŒºé—´æœ€å¤§é¢ç§¯
â‹®----
# å¦‚æœåˆ—è¡¨éç©ºï¼Œåˆ¤æ–­å½“å‰æ–‡æœ¬æ¡†æ˜¯ä¸åŒºé—´æœ€å¤§æ–‡æœ¬æ¡†åœ¨åŒä¸€åŒºåŸŸ
â‹®----
has_same_position = False
# éå†æ¯ä¸ªåŒºé—´æœ€å¤§æ–‡æœ¬æ¡†ï¼Œåˆ¤æ–­å½“å‰æ–‡æœ¬æ¡†ä½ç½®æ˜¯å¦ä¸åŒºé—´æœ€å¤§æ–‡æœ¬æ¡†åˆ—è¡¨çš„æŸä¸ªæ–‡æœ¬æ¡†ä½äºåŒä¸€è¡Œä¸”äº¤å‰
â‹®----
# å¦‚æœé«˜åº¦å·®å¼‚ä¸ä¸€æ ·
â‹®----
has_same_position = True
# å¦‚æœåœ¨åŒä¸€è¡Œï¼Œåˆ™è®¡ç®—å½“å‰é¢ç§¯æ˜¯ä¸æ˜¯æœ€å¤§
# åˆ¤æ–­é¢ç§¯å¤§å°ï¼Œè‹¥å½“å‰é¢ç§¯æ›´å¤§ï¼Œåˆ™å°†å½“å‰è¡Œçš„æœ€å¤§åŒºåŸŸåæ ‡ç‚¹æ›´æ–°
â‹®----
# å¦‚æœéå†äº†æ‰€æœ‰çš„åŒºé—´æœ€å¤§æ–‡æœ¬æ¡†åˆ—è¡¨ï¼Œå‘ç°æ˜¯æ–°çš„ä¸€è¡Œï¼Œåˆ™ç›´æ¥æ·»åŠ 
â‹®----
new_large_area = {
â‹®----
_area_max_box_list = list()
â‹®----
def get_subtitle_frame_no_box_dict_with_united_coordinates(self, subtitle_frame_no_box_dict)
â‹®----
"""
        å°†å¤šä¸ªè§†é¢‘å¸§çš„æ–‡æœ¬åŒºåŸŸåæ ‡ç»Ÿä¸€
        """
subtitle_frame_no_box_dict_with_united_coordinates = dict()
frame_no_list = self.find_continuous_ranges_with_same_mask(subtitle_frame_no_box_dict)
area_max_box_dict = self.get_area_max_box_dict(frame_no_list, subtitle_frame_no_box_dict)
â‹®----
area_max_box_list = area_max_box_dict[f'{start_no}->{end_no}']
current_boxes = subtitle_frame_no_box_dict[current_no]
new_subtitle_frame_no_box_list = []
â‹®----
large_xmin = max_box['xmin']
large_xmax = max_box['xmax']
large_ymin = max_box['ymin']
large_ymax = max_box['ymax']
box1 = (current_xmin, current_xmax, current_ymin, current_ymax)
box2 = (large_xmin, large_xmax, large_ymin, large_ymax)
res = self.compute_iou(box1, box2)
â‹®----
new_subtitle_frame_no_box = (large_xmin, large_xmax, large_ymin, large_ymax)
â‹®----
def prevent_missed_detection(self, subtitle_frame_no_box_dict)
â‹®----
"""
        æ·»åŠ é¢å¤–çš„æ–‡æœ¬æ¡†ï¼Œé˜²æ­¢æ¼æ£€
        """
â‹®----
current_box_list = subtitle_frame_no_box_dict[current_no]
â‹®----
next_box_list = subtitle_frame_no_box_dict[current_no + 1]
â‹®----
@staticmethod
    def get_frequency_in_range(sub_frame_no_list_continuous, subtitle_frame_no_box_dict)
â‹®----
sub_area_with_frequency = {}
â‹®----
def filter_mistake_sub_area(self, subtitle_frame_no_box_dict, fps)
â‹®----
"""
        è¿‡æ»¤é”™è¯¯çš„å­—å¹•åŒºåŸŸ
        """
sub_frame_no_list_continuous = self.find_continuous_ranges_with_same_mask(subtitle_frame_no_box_dict)
sub_area_with_frequency = self.get_frequency_in_range(sub_frame_no_list_continuous, subtitle_frame_no_box_dict)
correct_sub_area = []
â‹®----
correct_subtitle_frame_no_box_dict = dict()
â‹®----
current_box_list = subtitle_frame_no_box_dict[frame_no]
new_box_list = []
â‹®----
class SubtitleRemover
â‹®----
def __init__(self, vd_path, sub_area=None, gui_mode=False)
â‹®----
# çº¿ç¨‹é”
â‹®----
# ç”¨æˆ·æŒ‡å®šçš„å­—å¹•åŒºåŸŸä½ç½®
â‹®----
# æ˜¯å¦ä¸ºguiè¿è¡Œï¼Œguiè¿è¡Œéœ€è¦æ˜¾ç¤ºé¢„è§ˆ
â‹®----
# åˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡
â‹®----
# è§†é¢‘è·¯å¾„
â‹®----
# é€šè¿‡è§†é¢‘è·¯å¾„è·å–è§†é¢‘åç§°
â‹®----
# è§†é¢‘å¸§æ€»æ•°
â‹®----
# è§†é¢‘å¸§ç‡
â‹®----
# è§†é¢‘å°ºå¯¸
â‹®----
# åˆ›å»ºå­—å¹•æ£€æµ‹å¯¹è±¡
â‹®----
# åˆ›å»ºè§†é¢‘ä¸´æ—¶å¯¹è±¡ï¼Œwindowsä¸‹delete=Trueä¼šæœ‰permission deniedçš„æŠ¥é”™
â‹®----
# åˆ›å»ºè§†é¢‘å†™å¯¹è±¡
â‹®----
pic_dir = os.path.join(os.path.dirname(self.video_path), 'no_sub')
â‹®----
# æ€»å¤„ç†è¿›åº¦
â‹®----
# é¢„è§ˆå¸§
â‹®----
# æ˜¯å¦å°†åŸéŸ³é¢‘åµŒå…¥åˆ°å»é™¤å­—å¹•åçš„è§†é¢‘
â‹®----
@staticmethod
    def is_current_frame_no_start(frame_no, continuous_frame_no_list)
â‹®----
"""
        åˆ¤æ–­ç»™å®šçš„å¸§å·æ˜¯å¦ä¸ºå¼€å¤´ï¼Œæ˜¯çš„è¯è¿”å›ç»“æŸå¸§å·ï¼Œä¸æ˜¯çš„è¯è¿”å›-1
        """
â‹®----
@staticmethod
    def find_frame_no_end(frame_no, continuous_frame_no_list)
â‹®----
def update_progress(self, tbar, increment)
â‹®----
current_percentage = (tbar.n / tbar.total) * 100
â‹®----
def propainter_mode(self, tbar)
â‹®----
sub_list = self.sub_detector.find_subtitle_frame_no(sub_remover=self)
continuous_frame_no_list = self.sub_detector.find_continuous_ranges_with_same_mask(sub_list)
scene_div_points = self.sub_detector.get_scene_div_frame_no(self.video_path)
continuous_frame_no_list = self.sub_detector.split_range_by_scene(continuous_frame_no_list,
â‹®----
index = 0
â‹®----
# å¦‚æœå½“å‰å¸§æ²¡æœ‰æ°´å°/æ–‡æœ¬åˆ™ç›´æ¥å†™
â‹®----
# å¦‚æœæœ‰æ°´å°ï¼Œåˆ¤æ–­è¯¥å¸§æ˜¯ä¸æ˜¯å¼€å¤´å¸§
â‹®----
# å¦‚æœæ˜¯å¼€å¤´å¸§ï¼Œåˆ™æ‰¹æ¨ç†åˆ°å°¾å¸§
â‹®----
# print(f'No 1 Current index: {index}')
start_frame_no = index
â‹®----
# æ‰¾åˆ°ç»“æŸå¸§
end_frame_no = self.find_frame_no_end(index, continuous_frame_no_list)
# åˆ¤æ–­å½“å‰å¸§å·æ˜¯ä¸æ˜¯å­—å¹•èµ·å§‹ä½ç½®
# å¦‚æœè·å–çš„ç»“æŸå¸§å·ä¸ä¸º-1åˆ™è¯´æ˜
â‹®----
# ************ è¯»å–è¯¥åŒºé—´æ‰€æœ‰å¸§ start ************
temp_frames = list()
# å°†å¤´å¸§åŠ å…¥å¤„ç†åˆ—è¡¨
â‹®----
inner_index = 0
# ä¸€ç›´è¯»å–åˆ°å°¾å¸§
â‹®----
# ************ è¯»å–è¯¥åŒºé—´æ‰€æœ‰å¸§ end ************
â‹®----
# æ²¡æœ‰å¾…å¤„ç†ï¼Œç›´æ¥è·³è¿‡
â‹®----
single_mask = create_mask(self.mask_size, sub_list[index])
â‹®----
inpainted_frame = self.lama_inpaint(frame, single_mask)
â‹®----
# å°†è¯»å–çš„è§†é¢‘å¸§åˆ†æ‰¹å¤„ç†
# 1. è·å–å½“å‰æ‰¹æ¬¡ä½¿ç”¨çš„mask
mask = create_mask(self.mask_size, sub_list[start_frame_no])
â‹®----
# 2. è°ƒç”¨æ‰¹æ¨ç†
â‹®----
single_mask = create_mask(self.mask_size, sub_list[start_frame_no])
â‹®----
inpainted_frames = self.video_inpaint.inpaint(batch, mask)
â‹®----
def sttn_mode_with_no_detection(self, tbar)
â‹®----
"""
        ä½¿ç”¨sttnå¯¹é€‰ä¸­åŒºåŸŸè¿›è¡Œé‡ç»˜ï¼Œä¸è¿›è¡Œå­—å¹•æ£€æµ‹
        """
â‹®----
mask_area_coordinates = [(xmin, xmax, ymin, ymax)]
mask = create_mask(self.mask_size, mask_area_coordinates)
sttn_video_inpaint = STTNVideoInpaint(self.video_path)
â‹®----
def sttn_mode(self, tbar)
â‹®----
# æ˜¯å¦è·³è¿‡å­—å¹•å¸§å¯»æ‰¾
â‹®----
# è‹¥è·³è¿‡åˆ™ä¸–ç•Œä½¿ç”¨sttnæ¨¡å¼
â‹®----
sttn_inpaint = STTNInpaint()
â‹®----
continuous_frame_no_list = self.sub_detector.filter_and_merge_intervals(continuous_frame_no_list)
â‹®----
start_end_map = dict()
â‹®----
current_frame_index = 0
â‹®----
# å¦‚æœè¯»å–åˆ°ä¸ºï¼Œåˆ™ç»“æŸ
â‹®----
# åˆ¤æ–­å½“å‰å¸§å·æ˜¯ä¸æ˜¯å­—å¹•åŒºé—´å¼€å§‹, å¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥å†™
â‹®----
# å¦‚æœæ˜¯åŒºé—´å¼€å§‹ï¼Œåˆ™æ‰¾åˆ°å°¾å·´
â‹®----
start_frame_index = current_frame_index
end_frame_index = start_end_map[current_frame_index]
â‹®----
# ç”¨äºå­˜å‚¨éœ€è¦å»å­—å¹•çš„è§†é¢‘å¸§
frames_need_inpaint = list()
â‹®----
# æ¥ç€å¾€ä¸‹è¯»ï¼Œç›´åˆ°è¯»å–åˆ°å°¾å·´
â‹®----
mask_area_coordinates = []
# 1. è·å–å½“å‰æ‰¹æ¬¡çš„maskåæ ‡å…¨é›†
â‹®----
# åˆ¤æ–­æ˜¯ä¸æ˜¯éå­—å¹•åŒºåŸŸ(å¦‚æœå®½å¤§äºé•¿ï¼Œåˆ™è®¤ä¸ºæ˜¯é”™è¯¯æ£€æµ‹)
â‹®----
inpainted_frames = sttn_inpaint(batch, mask)
â‹®----
def lama_mode(self, tbar)
â‹®----
original_frame = frame
â‹®----
mask = create_mask(self.mask_size, sub_list[index])
â‹®----
frame = cv2.inpaint(frame, mask, 3, cv2.INPAINT_TELEA)
â‹®----
frame = self.lama_inpaint(frame, mask)
â‹®----
def run(self)
â‹®----
# è®°å½•å¼€å§‹æ—¶é—´
start_time = time.time()
# é‡ç½®è¿›åº¦æ¡
â‹®----
tbar = tqdm(total=int(self.frame_count), unit='frame', position=0, file=sys.__stdout__,
â‹®----
original_frame = cv2.imread(self.video_path)
â‹®----
mask = create_mask(original_frame.shape[0:2], sub_list[1])
inpainted_frame = self.lama_inpaint(original_frame, mask)
â‹®----
inpainted_frame = original_frame
â‹®----
# ç²¾å‡†æ¨¡å¼ä¸‹ï¼Œè·å–åœºæ™¯åˆ†å‰²çš„å¸§å·ï¼Œè¿›ä¸€æ­¥åˆ‡å‰²
â‹®----
# å°†åŸéŸ³é¢‘åˆå¹¶åˆ°æ–°ç”Ÿæˆçš„è§†é¢‘æ–‡ä»¶ä¸­
â‹®----
def merge_audio_to_video(self)
â‹®----
# åˆ›å»ºéŸ³é¢‘ä¸´æ—¶å¯¹è±¡ï¼Œwindowsä¸‹delete=Trueä¼šæœ‰permission deniedçš„æŠ¥é”™
temp = tempfile.NamedTemporaryFile(suffix='.aac', delete=False)
audio_extract_command = [config.FFMPEG_PATH,
use_shell = True if os.name == "nt" else False
â‹®----
audio_merge_command = [config.FFMPEG_PATH,
â‹®----
# 1. æç¤ºç”¨æˆ·è¾“å…¥è§†é¢‘è·¯å¾„
video_path = input(f"Please input video or image file path: ").strip()
# åˆ¤æ–­è§†é¢‘è·¯å¾„æ˜¯ä¸æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ˜¯ç›®å½•çš„åŒ–ï¼Œæ‰¹é‡å¤„ç†æ”¹ç›®å½•ä¸‹çš„æ‰€æœ‰è§†é¢‘æ–‡ä»¶
# 2. æŒ‰ä»¥ä¸‹é¡ºåºä¼ å…¥å­—å¹•åŒºåŸŸ
# sub_area = (ymin, ymax, xmin, xmax)
# 3. æ–°å»ºå­—å¹•æå–å¯¹è±¡
â‹®----
sd = SubtitleRemover(video_path, sub_area=None)
</file>

<file path="README.md">
ç®€ä½“ä¸­æ–‡ | [English](README_en.md)

## é¡¹ç›®ç®€ä»‹

![License](https://img.shields.io/badge/License-Apache%202-red.svg)
![python version](https://img.shields.io/badge/Python-3.11+-blue.svg)
![support os](https://img.shields.io/badge/OS-Windows/macOS/Linux-green.svg)  

Video-subtitle-remover (VSR) æ˜¯ä¸€æ¬¾åŸºäºAIæŠ€æœ¯ï¼Œå°†è§†é¢‘ä¸­çš„ç¡¬å­—å¹•å»é™¤çš„è½¯ä»¶ã€‚
ä¸»è¦å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š
- **æ— æŸåˆ†è¾¨ç‡**å°†è§†é¢‘ä¸­çš„ç¡¬å­—å¹•å»é™¤ï¼Œç”Ÿæˆå»é™¤å­—å¹•åçš„æ–‡ä»¶
- é€šè¿‡è¶…å¼ºAIç®—æ³•æ¨¡å‹ï¼Œå¯¹å»é™¤å­—å¹•æ–‡æœ¬çš„åŒºåŸŸè¿›è¡Œå¡«å……ï¼ˆéç›¸é‚»åƒç´ å¡«å……ä¸é©¬èµ›å…‹å»é™¤ï¼‰
- æ”¯æŒè‡ªå®šä¹‰å­—å¹•ä½ç½®ï¼Œä»…å»é™¤å®šä¹‰ä½ç½®ä¸­çš„å­—å¹•ï¼ˆä¼ å…¥ä½ç½®ï¼‰
- æ”¯æŒå…¨è§†é¢‘è‡ªåŠ¨å»é™¤æ‰€æœ‰æ–‡æœ¬ï¼ˆä¸ä¼ å…¥ä½ç½®ï¼‰
- æ”¯æŒå¤šé€‰å›¾ç‰‡æ‰¹é‡å»é™¤æ°´å°æ–‡æœ¬

<p style="text-align:center;"><img src="https://github.com/YaoFANGUK/video-subtitle-remover/raw/main/design/demo.png" alt="demo.png"/></p>

**ä½¿ç”¨è¯´æ˜ï¼š**

- æœ‰ä½¿ç”¨é—®é¢˜è¯·åŠ ç¾¤è®¨è®ºï¼ŒQQç¾¤ï¼š210150985ï¼ˆå·²æ»¡ï¼‰ã€806152575ï¼ˆå·²æ»¡ï¼‰ã€816881808ï¼ˆå·²æ»¡ï¼‰ã€295894827
- ç›´æ¥ä¸‹è½½å‹ç¼©åŒ…è§£å‹è¿è¡Œï¼Œå¦‚æœä¸èƒ½è¿è¡Œå†æŒ‰ç…§ä¸‹é¢çš„æ•™ç¨‹ï¼Œå°è¯•æºç å®‰è£…condaç¯å¢ƒè¿è¡Œ

**ä¸‹è½½åœ°å€ï¼š**

Windows GPUç‰ˆæœ¬v1.1.0ï¼ˆGPUï¼‰ï¼š

- ç™¾åº¦ç½‘ç›˜:  <a href="https://pan.baidu.com/s/1zR6CjRztmOGBbOkqK8R1Ng?pwd=vsr1">vsr_windows_gpu_v1.1.0.zip</a> æå–ç ï¼š**vsr1**

- Google Drive:  <a href="https://drive.google.com/drive/folders/1NRgLNoHHOmdO4GxLhkPbHsYfMOB_3Elr?usp=sharing">vsr_windows_gpu_v1.1.0.zip</a>

**é¢„æ„å»ºåŒ…å¯¹æ¯”è¯´æ˜**ï¼š
|       é¢„æ„å»ºåŒ…å          | Python  | Paddle | Torch | ç¯å¢ƒ                          | æ”¯æŒçš„è®¡ç®—èƒ½åŠ›èŒƒå›´|
|---------------|------------|--------------|--------------|-----------------------------|----------|
| `vsr-windows-directml.7z`  | 3.12       | 3.0.0       | 2.4.1       | Windows éNvidiaæ˜¾å¡             | é€šç”¨ |
| `vsr-windows-nvidia-cuda-11.8.7z` | 3.12       | 3.0.0        | 2.7.0       | CUDA 11.8   | 3.5 â€“ 8.9 |
| `vsr-windows-nvidia-cuda-12.6.7z` | 3.12       | 3.0.0       | 2.7.0       | CUDA 12.6   | 5.0 â€“ 8.9 |
| `vsr-windows-nvidia-cuda-12.8.7z` | 3.12       | 3.0.0       | 2.7.0       | CUDA 12.8   | 5.0 â€“ 9.0+ |

> NVIDIAå®˜æ–¹æä¾›äº†å„GPUå‹å·çš„è®¡ç®—èƒ½åŠ›åˆ—è¡¨ï¼Œæ‚¨å¯ä»¥å‚è€ƒé“¾æ¥: [CUDA GPUs](https://developer.nvidia.com/cuda-gpus) æŸ¥çœ‹ä½ çš„GPUé€‚åˆå“ªä¸ªCUDAç‰ˆæœ¬

**Dockerç‰ˆæœ¬ï¼š**
```shell
  # Nvidia 10 20 30ç³»æ˜¾å¡
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-cuda11.8

  # Nvidia 40ç³»æ˜¾å¡
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-cuda12.6

  # Nvidia 50ç³»æ˜¾å¡
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-cuda12.8

  # AMD / Intel ç‹¬æ˜¾ é›†æ˜¾
  docker run -it --name vsr --gpus all eritpchy/video-subtitle-remover:1.1.1-directml

  # æ¼”ç¤ºè§†é¢‘, è¾“å…¥
  /vsr/test/test.mp4
  docker cp vsr:/vsr/test/test_no_sub.mp4 ./
```

## æ¼”ç¤º

- GUIç‰ˆï¼š

<p style="text-align:center;"><img src="https://github.com/YaoFANGUK/video-subtitle-remover/raw/main/design/demo2.gif" alt="demo2.gif"/></p>

- <a href="https://b23.tv/guEbl9C">ç‚¹å‡»æŸ¥çœ‹æ¼”ç¤ºè§†é¢‘ğŸ‘‡</a>

<p style="text-align:center;"><a href="https://b23.tv/guEbl9C"><img src="https://github.com/YaoFANGUK/video-subtitle-remover/raw/main/design/demo.gif" alt="demo.gif"/></a></p>

## æºç ä½¿ç”¨è¯´æ˜


#### 1. å®‰è£… Python

è¯·ç¡®ä¿æ‚¨å·²ç»å®‰è£…äº† Python 3.12+ã€‚

- Windows ç”¨æˆ·å¯ä»¥å‰å¾€ [Python å®˜ç½‘](https://www.python.org/downloads/windows/) ä¸‹è½½å¹¶å®‰è£… Pythonã€‚
- MacOS ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Homebrew å®‰è£…ï¼š
  ```shell
  brew install python@3.12
  ```
- Linux ç”¨æˆ·å¯ä»¥ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œä¾‹å¦‚ Ubuntu/Debianï¼š
  ```shell
  sudo apt update && sudo apt install python3.12 python3.12-venv python3.12-dev
  ```

#### 2. å®‰è£…ä¾èµ–æ–‡ä»¶

è¯·ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒæ¥ç®¡ç†é¡¹ç›®ä¾èµ–ï¼Œé¿å…ä¸ç³»ç»Ÿç¯å¢ƒå†²çªã€‚

ï¼ˆ1ï¼‰åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶æ¿€æ´»
```shell
python -m venv videoEnv
```

- Windowsï¼š
```shell
videoEnv\\Scripts\\activate
```
- MacOS/Linuxï¼š
```shell
source videoEnv/bin/activate
```

#### 3. åˆ›å»ºå¹¶æ¿€æ´»é¡¹ç›®ç›®å½•

åˆ‡æ¢åˆ°æºç æ‰€åœ¨ç›®å½•ï¼š
```shell
cd <æºç æ‰€åœ¨ç›®å½•>
```
> ä¾‹å¦‚ï¼šå¦‚æœæ‚¨çš„æºä»£ç æ”¾åœ¨ D ç›˜çš„ tools æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶ä¸”æºä»£ç çš„æ–‡ä»¶å¤¹åä¸º video-subtitle-removerï¼Œåˆ™è¾“å…¥ï¼š
> ```shell
> cd D:/tools/video-subtitle-remover-main
> ```

#### 4. å®‰è£…åˆé€‚çš„è¿è¡Œç¯å¢ƒ

æœ¬é¡¹ç›®æ”¯æŒ CUDAï¼ˆNVIDIAæ˜¾å¡åŠ é€Ÿï¼‰å’Œ DirectMLï¼ˆAMDã€Intelç­‰GPU/APUåŠ é€Ÿï¼‰ä¸¤ç§è¿è¡Œæ¨¡å¼ã€‚

##### (1) CUDAï¼ˆNVIDIA æ˜¾å¡ç”¨æˆ·ï¼‰

> è¯·ç¡®ä¿æ‚¨çš„ NVIDIA æ˜¾å¡é©±åŠ¨æ”¯æŒæ‰€é€‰ CUDA ç‰ˆæœ¬ã€‚

- æ¨è CUDA 11.8ï¼Œå¯¹åº” cuDNN 8.6.0ã€‚

- å®‰è£… CUDAï¼š
  - Windowsï¼š[CUDA 11.8 ä¸‹è½½](https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_522.06_windows.exe)
  - Linuxï¼š
    ```shell
    wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda_11.8.0_520.61.05_linux.run
    sudo sh cuda_11.8.0_520.61.05_linux.run
    ```
  - MacOS ä¸æ”¯æŒ CUDAã€‚

- å®‰è£… cuDNNï¼ˆCUDA 11.8 å¯¹åº” cuDNN 8.6.0ï¼‰ï¼š
  - [Windows cuDNN 8.6.0 ä¸‹è½½](https://developer.download.nvidia.cn/compute/redist/cudnn/v8.6.0/local_installers/11.8/cudnn-windows-x86_64-8.6.0.163_cuda11-archive.zip)
  - [Linux cuDNN 8.6.0 ä¸‹è½½](https://developer.download.nvidia.cn/compute/redist/cudnn/v8.6.0/local_installers/11.8/cudnn-linux-x86_64-8.6.0.163_cuda11-archive.tar.xz)
  - å®‰è£…æ–¹æ³•è¯·å‚è€ƒ NVIDIA å®˜æ–¹æ–‡æ¡£ã€‚

- å®‰è£… PaddlePaddle GPU ç‰ˆæœ¬ï¼ˆCUDA 11.8ï¼‰ï¼š
  ```shell
  pip install paddlepaddle-gpu==3.0.0 -i https://www.paddlepaddle.org.cn/packages/stable/cu118/
  ```
- å®‰è£… Torch GPU ç‰ˆæœ¬ï¼ˆCUDA 11.8ï¼‰ï¼š
  ```shell
  pip install torch==2.7.0 torchvision==0.22.0 --index-url https://download.pytorch.org/whl/cu118
  ```

- å®‰è£…å…¶ä»–ä¾èµ–
  ```shell
  pip install -r requirements.txt
  ```

##### (2) DirectMLï¼ˆAMDã€Intelç­‰GPU/APUåŠ é€Ÿå¡ç”¨æˆ·ï¼‰

- é€‚ç”¨äº Windows è®¾å¤‡çš„ AMD/NVIDIA/Intel GPUã€‚
- å®‰è£… ONNX Runtime DirectML ç‰ˆæœ¬ï¼š
  ```shell
  pip install paddlepaddle==3.0.0 -i https://www.paddlepaddle.org.cn/packages/stable/cpu/
  pip install -r requirements.txt
  pip install torch_directml==0.2.5.dev240914
  ```


#### 4. è¿è¡Œç¨‹åº

- è¿è¡Œå›¾å½¢åŒ–ç•Œé¢

```shell
python gui.py
```

- è¿è¡Œå‘½ä»¤è¡Œç‰ˆæœ¬(CLI)

```shell
python ./backend/main.py
```

## å¸¸è§é—®é¢˜
1. æå–é€Ÿåº¦æ…¢æ€ä¹ˆåŠ

ä¿®æ”¹backend/config.pyä¸­çš„å‚æ•°ï¼Œå¯ä»¥å¤§å¹…åº¦æé«˜å»é™¤é€Ÿåº¦
```python
MODE = InpaintMode.STTN  # è®¾ç½®ä¸ºSTTNç®—æ³•
STTN_SKIP_DETECTION = True # è·³è¿‡å­—å¹•æ£€æµ‹ï¼Œè·³è¿‡åå¯èƒ½ä¼šå¯¼è‡´è¦å»é™¤çš„å­—å¹•é—æ¼æˆ–è€…è¯¯ä¼¤ä¸éœ€è¦å»é™¤å­—å¹•çš„è§†é¢‘å¸§
```

2. è§†é¢‘å»é™¤æ•ˆæœä¸å¥½æ€ä¹ˆåŠ

ä¿®æ”¹backend/config.pyä¸­çš„å‚æ•°ï¼Œå°è¯•ä¸åŒçš„å»é™¤ç®—æ³•ï¼Œç®—æ³•ä»‹ç»

> - InpaintMode.STTN ç®—æ³•ï¼šå¯¹äºçœŸäººè§†é¢‘æ•ˆæœè¾ƒå¥½ï¼Œé€Ÿåº¦å¿«ï¼Œå¯ä»¥è·³è¿‡å­—å¹•æ£€æµ‹
> - InpaintMode.LAMA ç®—æ³•ï¼šå¯¹äºå›¾ç‰‡æ•ˆæœæœ€å¥½ï¼Œå¯¹åŠ¨ç”»ç±»è§†é¢‘æ•ˆæœå¥½ï¼Œé€Ÿåº¦ä¸€èˆ¬ï¼Œä¸å¯ä»¥è·³è¿‡å­—å¹•æ£€æµ‹
> - InpaintMode.PROPAINTER ç®—æ³•ï¼š éœ€è¦æ¶ˆè€—å¤§é‡æ˜¾å­˜ï¼Œé€Ÿåº¦è¾ƒæ…¢ï¼Œå¯¹è¿åŠ¨éå¸¸å‰§çƒˆçš„è§†é¢‘æ•ˆæœè¾ƒå¥½

- ä½¿ç”¨STTNç®—æ³•

```python
MODE = InpaintMode.STTN  # è®¾ç½®ä¸ºSTTNç®—æ³•
# ç›¸é‚»å¸§æ•°, è°ƒå¤§ä¼šå¢åŠ æ˜¾å­˜å ç”¨ï¼Œæ•ˆæœå˜å¥½
STTN_NEIGHBOR_STRIDE = 10
# å‚è€ƒå¸§é•¿åº¦, è°ƒå¤§ä¼šå¢åŠ æ˜¾å­˜å ç”¨ï¼Œæ•ˆæœå˜å¥½
STTN_REFERENCE_LENGTH = 10
# è®¾ç½®STTNç®—æ³•æœ€å¤§åŒæ—¶å¤„ç†çš„å¸§æ•°é‡ï¼Œè®¾ç½®è¶Šå¤§é€Ÿåº¦è¶Šæ…¢ï¼Œä½†æ•ˆæœè¶Šå¥½
# è¦ä¿è¯STTN_MAX_LOAD_NUMå¤§äºSTTN_NEIGHBOR_STRIDEå’ŒSTTN_REFERENCE_LENGTH
STTN_MAX_LOAD_NUM = 30
```
- ä½¿ç”¨LAMAç®—æ³•
```python
MODE = InpaintMode.LAMA  # è®¾ç½®ä¸ºSTTNç®—æ³•
LAMA_SUPER_FAST = False  # ä¿è¯æ•ˆæœ
```

> å¦‚æœå¯¹æ¨¡å‹å»å­—å¹•çš„æ•ˆæœä¸æ»¡æ„ï¼Œå¯ä»¥æŸ¥çœ‹designæ–‡ä»¶å¤¹é‡Œé¢çš„è®­ç»ƒæ–¹æ³•ï¼Œåˆ©ç”¨backend/tools/trainé‡Œé¢çš„ä»£ç è¿›è¡Œè®­ç»ƒï¼Œç„¶åå°†è®­ç»ƒçš„æ¨¡å‹æ›¿æ¢æ—§æ¨¡å‹å³å¯

3. CondaHTTPError

å°†é¡¹ç›®ä¸­çš„.condarcæ”¾åœ¨ç”¨æˆ·ç›®å½•ä¸‹(C:/Users/<ä½ çš„ç”¨æˆ·å>)ï¼Œå¦‚æœç”¨æˆ·ç›®å½•å·²ç»å­˜åœ¨è¯¥æ–‡ä»¶åˆ™è¦†ç›–

è§£å†³æ–¹æ¡ˆï¼šhttps://zhuanlan.zhihu.com/p/260034241

4. 7zæ–‡ä»¶è§£å‹é”™è¯¯

è§£å†³æ–¹æ¡ˆï¼šå‡çº§7-zipè§£å‹ç¨‹åºåˆ°æœ€æ–°ç‰ˆæœ¬


## èµåŠ©

<img src="https://github.com/YaoFANGUK/video-subtitle-extractor/raw/main/design/sponsor.png" width="600">

| æèµ è€…                       | ç´¯è®¡æèµ é‡‘é¢     | èµåŠ©å¸­ä½ |
|---------------------------|------------| --- |
| å¤V                        | 400.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| Jenkit                        | 200.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| å­è½¦æ¾å…°                        | 188.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| è½èŠ±æœªé€                        | 100.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| å¼ éŸ³ä¹                        | 100.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| éº¦æ ¼                        | 100.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| æ— ç—•                        | 100.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| wr                        | 100.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| é™ˆ                        | 100.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| lyons                        | 100.00 RMB | é‡‘ç‰ŒèµåŠ©å¸­ä½ |
| TalkLuv                   | 50.00 RMB  | é“¶ç‰ŒèµåŠ©å¸­ä½ |
| é™ˆå‡¯                        | 50.00 RMB  | é“¶ç‰ŒèµåŠ©å¸­ä½ |
| Tshuang                   | 20.00 RMB  | é“¶ç‰ŒèµåŠ©å¸­ä½ |
| å¾ˆå¥‡å¼‚                       | 15.00 RMB  | é“¶ç‰ŒèµåŠ©å¸­ä½ |
| éƒ­é‘«                       | 12.00 RMB  | é“¶ç‰ŒèµåŠ©å¸­ä½ |
| ç”Ÿæ´»ä¸æ­¢çœ¼å‰çš„è‹Ÿä¸”                        | 10.00 RMB  | é“œç‰ŒèµåŠ©å¸­ä½ |
| ä½•æ–                        | 10.00 RMB  | é“œç‰ŒèµåŠ©å¸­ä½ |
| è€çŒ«                        | 8.80 RMB   | é“œç‰ŒèµåŠ©å¸­ä½ |
| ä¼å…­ä¸ƒ                      | 7.77 RMB   | é“œç‰ŒèµåŠ©å¸­ä½ |
| é•¿ç¼¨åœ¨æ‰‹                      | 6.00 RMB   | é“œç‰ŒèµåŠ©å¸­ä½ |
| æ— å¿Œ                      | 6.00 RMB   | é“œç‰ŒèµåŠ©å¸­ä½ |
| Stephen                   | 2.00 RMB   | é“œç‰ŒèµåŠ©å¸­ä½ |
| Leo                       | 1.00 RMB   | é“œç‰ŒèµåŠ©å¸­ä½ |
</file>

</files>
